<div class="conceitos-container">

  <!-- Header: t√≠tulo + stats (mesmo estilo de Flash Cards e Perguntas) -->
  <div class="header" *ngIf="showHeader">
    <h2>{{ moduleEmoji ? (moduleEmoji + ' ') : 'üß≠ ' }}{{ moduleLabel || 'Conceitos' }}</h2>
    <div class="stats" *ngIf="!loading">
      <span class="stat-item">
        <strong>{{ filteredConceitos.length }}</strong> de <strong>{{ conceitosFiltradosPorBibliografia.length }}</strong> conceitos
      </span>
      <span class="stat-item">
        <strong>{{ bibliografias.length }}</strong> {{ bibliografias.length === 1 ? 'bibliografia' : 'bibliografias' }}
      </span>
      <span class="stat-item">
        <strong>{{ assuntosDisponiveis.length }}</strong> {{ assuntosDisponiveis.length === 1 ? 'assunto' : 'assuntos' }}
      </span>
    </div>
  </div>

  <!-- Bot√µes de navega√ß√£o (preservados) -->
  <nav class="navigation-buttons" aria-label="Navega√ß√£o" *ngIf="showHeader && !loading">
    <button class="btn btn-back" (click)="navigateTo(getPath('bibliografia'))" aria-label="Voltar para Bibliografia">
      <span class="back-arrow"></span>
      Voltar √† Bibliografia
    </button>
    <button mat-stroked-button (click)="navigateTo(conceitosPath)" *ngIf="conceitosPath">
      <mat-icon>category</mat-icon> Conceitos
    </button>
    <button mat-stroked-button (click)="navigateTo(flashcardsPath)" *ngIf="flashcardsPath">
      <mat-icon>style</mat-icon> Flashcards
    </button>
    <button mat-stroked-button (click)="navigateTo(mediaPath)" *ngIf="mediaPath">
      <mat-icon>play_circle</mat-icon> Media
    </button>
    <button mat-stroked-button (click)="navigateTo(perguntasPath)" *ngIf="perguntasPath">
      <mat-icon>quiz</mat-icon> Perguntas
    </button>
  </nav>

  <!-- Loading state -->
  <app-loading-spinner *ngIf="loading" message="Carregando conceitos..."></app-loading-spinner>

  <!-- Error state -->
  <div class="error-state" *ngIf="error && !loading">
    <div class="error-icon">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="15" y1="9" x2="9" y2="15"></line>
        <line x1="9" y1="9" x2="15" y2="15"></line>
      </svg>
    </div>
    <p class="error-message">{{ error }}</p>
    <button 
      class="retry-button" 
      (click)="loadConceitos()">
      Tentar novamente
    </button>
  </div>

  <!-- Content with tabs -->
  <div *ngIf="!loading && !error" class="content-container">
    <!-- Filtros (Bibliografia + Assunto) -->
    <div class="filters-section" *ngIf="!loading">
      <div class="filter-row">
        <div class="filter-group">
          <label for="bibliografia-filter">üìñ Bibliografia:</label>
          <select
            id="bibliografia-filter"
            name="bibliografia"
            [(ngModel)]="selectedBibliografiaId"
            (ngModelChange)="onBibliografiaChange()"
            class="filter-select">
            <option [ngValue]="null">Todas as Bibliografias</option>
            <option *ngFor="let bib of bibliografias" [ngValue]="bib.id">{{ bib.titulo }}</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="assunto-filter">üè∑Ô∏è Assunto:</label>
          <select
            id="assunto-filter"
            name="assunto"
            [(ngModel)]="selectedAssunto"
            (ngModelChange)="onAssuntoChange()"
            class="filter-select"
            [disabled]="assuntosDisponiveis.length === 0">
            <option value="">Todos os assuntos</option>
            <option *ngFor="let assunto of assuntosDisponiveis" [value]="assunto">{{ assunto }}</option>
          </select>
        </div>
      </div>

      <!-- A√ß√µes -->
      <div class="actions-row">
        <button 
          class="btn btn-fullscreen"
          (click)="openFullscreen()"
          [disabled]="filteredConceitos.length === 0">
          üñ•Ô∏è Tela Cheia
        </button>
        
        <button 
          class="btn btn-pdf"
          (click)="downloadAsPDF()"
          [disabled]="filteredConceitos.length === 0 || isGeneratingPDF">
          <mat-icon *ngIf="!isGeneratingPDF">picture_as_pdf</mat-icon>
          <mat-spinner *ngIf="isGeneratingPDF" diameter="16"></mat-spinner>
          {{ isGeneratingPDF ? 'Gerando PDF...' : 'Salvar PDF' }}
        </button>
        
        <button class="btn btn-outline" (click)="resetFilters()" [disabled]="!selectedBibliografiaId && !selectedAssunto">‚úñÔ∏è Limpar Filtros</button>
      </div>
    </div>

    <!-- Conceitos table -->
    <app-conceitos-table 
      [conceitos]="filteredConceitos"
      [title]="!showHeader ? (bibliografias.length <= 1 ? 'Conceitos' : 'Conceitos da Bibliografia') : ''"
      [showBibliografia]="bibliografias.length <= 1"
      [emptyMessage]="getEmptyMessage()">
    </app-conceitos-table>
  </div>

  <!-- Fullscreen Overlay -->
  <div class="fullscreen-overlay" *ngIf="isFullscreen">
    <div class="fullscreen-container">
      <div class="fullscreen-header">
        <h3>{{ moduleEmoji ? (moduleEmoji + ' ') : 'üß≠ ' }}{{ moduleLabel || 'Conceitos' }} - Modo Tela Cheia</h3>
        <button 
          class="btn-close-fullscreen"
          (click)="exitFullscreen()"
          aria-label="Fechar tela cheia">
          ‚úï
        </button>
      </div>
      
      <!-- Filtros no Fullscreen -->
      <div class="fullscreen-filters">
        <div class="filter-row">
          <div class="filter-group">
            <label for="fullscreen-bibliografia-filter">üìñ Bibliografia:</label>
            <select
              id="fullscreen-bibliografia-filter"
              name="bibliografia"
              [(ngModel)]="selectedBibliografiaId"
              (ngModelChange)="onBibliografiaChange()"
              class="filter-select">
              <option [ngValue]="null">Todas as Bibliografias</option>
              <option *ngFor="let bib of bibliografias" [ngValue]="bib.id">{{ bib.titulo }}</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="fullscreen-assunto-filter">üè∑Ô∏è Assunto:</label>
            <select
              id="fullscreen-assunto-filter"
              name="assunto"
              [(ngModel)]="selectedAssunto"
              (ngModelChange)="onAssuntoChange()"
              class="filter-select"
              [disabled]="assuntosDisponiveis.length === 0">
              <option value="">Todos os assuntos</option>
              <option *ngFor="let assunto of assuntosDisponiveis" [value]="assunto">{{ assunto }}</option>
            </select>
          </div>

          <div class="filter-group filter-group-button">
            <label>&nbsp;</label>
            <button 
              class="btn btn-pdf" 
              (click)="downloadAsPDF()" 
              [disabled]="filteredConceitos.length === 0 || isGeneratingPDF">
              <mat-icon *ngIf="!isGeneratingPDF">picture_as_pdf</mat-icon>
              <mat-spinner *ngIf="isGeneratingPDF" diameter="16"></mat-spinner>
              {{ isGeneratingPDF ? 'Gerando...' : 'üìÑ PDF' }}
            </button>
          </div>
          <div class="filter-group filter-group-button">
            <label>&nbsp;</label>
            <button 
              class="btn btn-outline" 
              (click)="resetFilters()" 
              [disabled]="!selectedBibliografiaId && !selectedAssunto">
              ‚úñÔ∏è Limpar Filtros
            </button>
          </div>
        </div>
      </div>
      
      <div class="fullscreen-content">
        <app-conceitos-table 
          [conceitos]="filteredConceitos"
          [title]="''"
          [showBibliografia]="bibliografias.length <= 1"
          [emptyMessage]="getEmptyMessage()">
        </app-conceitos-table>
      </div>
      
      <div class="fullscreen-actions">
        <button 
          class="btn btn-pdf"
          (click)="downloadAsPDF()"
          [disabled]="filteredConceitos.length === 0 || isGeneratingPDF">
          <mat-icon *ngIf="!isGeneratingPDF">picture_as_pdf</mat-icon>
          <mat-spinner *ngIf="isGeneratingPDF" diameter="16"></mat-spinner>
          {{ isGeneratingPDF ? 'Gerando PDF...' : 'üìÑ Salvar PDF' }}
        </button>
        <button 
          class="btn btn-outline"
          (click)="exitFullscreen()">
          ‚úñÔ∏è Fechar (ESC)
        </button>
      </div>
    </div>
  </div>
</div>
