<div class="markdown-viewer">
  <header class="viewer-header">
    <div>
      <h1>Texto de apoio</h1>
      <p *ngIf="question">
        Pergunta {{ question.id }} · {{ question.tipo_display || question.tipo.toUpperCase() }}
      </p>
    </div>
    <button class="btn-close" type="button" (click)="closeWindow()">Fechar</button>
  </header>

  <section class="info-card" *ngIf="question">
    <p><strong>Bibliografia:</strong> {{ question.bibliografia_titulo || '—' }}</p>
    <p><strong>Assunto:</strong> {{ question.assunto_titulo || '—' }}</p>
    <p><strong>Arquivo Markdown:</strong> {{ question.markdown_file || 'Não configurado' }}</p>
  </section>

  <section class="legend" *ngIf="!errorMessage">
    <div class="legend-item" *ngFor="let item of legendEntries">
      <span class="color-dot" [style.background]="item.color"></span>
      <span>{{ item.label }}</span>
    </div>
  </section>

  <section class="global-highlights" [class.is-collapsed]="!showGlobalHighlights">
    <div class="section-header">
      <div>
        <h3>Marcações existentes</h3>
        <p>Visão geral de todas as questões que utilizam este arquivo.</p>
      </div>
      <button class="btn-toggle" type="button" (click)="toggleGlobalHighlights()">
        {{ showGlobalHighlights ? 'Ocultar' : 'Mostrar' }}
      </button>
    </div>

    <div class="global-content" *ngIf="showGlobalHighlights">
      <p *ngIf="sortedGlobalHighlights.length === 0" class="muted">Nenhuma marcação cadastrada para este arquivo.</p>
      <ul *ngIf="sortedGlobalHighlights.length > 0">
        <li *ngFor="let entry of sortedGlobalHighlights">
          <span class="color-dot" [style.background]="getTipoColor(entry.pergunta_tipo)"></span>
          <div class="highlight-entry">
            <strong>{{ getTipoLabel(entry.pergunta_tipo) }} · Pergunta {{ entry.pergunta_id }}</strong>
            <small>
              {{ entry.bibliografia_titulo || '—' }}
              <ng-container *ngIf="entry.assunto_titulo"> · {{ entry.assunto_titulo }}</ng-container>
            </small>
            <p>"{{ entry.highlight.text }}"</p>
          </div>
          <button
            *ngIf="isAdmin"
            class="btn-link"
            type="button"
            (click)="removeGlobalHighlight(entry)"
            [disabled]="globalActionInProgress">
            Remover
          </button>
        </li>
      </ul>

      <div class="global-actions" *ngIf="isAdmin && sortedGlobalHighlights.length > 0">
        <button
          class="btn btn-secondary"
          type="button"
          (click)="clearAllHighlightsForPage()"
          [disabled]="globalActionInProgress">
          {{ globalActionInProgress && globalActionTarget === 'clear-page' ? 'Limpando...' : 'Limpar todas as marcações deste arquivo' }}
        </button>
      </div>
    </div>
  </section>

  <section class="admin-section" *ngIf="isAdmin && question?.markdown_file">
    <div class="pending-highlight" [class.is-active]="!!pendingHighlight">
      <div class="card-header">
        <h3>Nova marcação</h3>
        <p>Selecione um trecho no texto para preencher os campos abaixo.</p>
      </div>

      <ng-container *ngIf="pendingHighlight; else pendingInstructions">
        <p class="selection-text">"{{ pendingHighlight.text }}"</p>

        <label>
          Observação
          <textarea rows="2" [(ngModel)]="pendingHighlight.note"></textarea>
        </label>

        <label>
          Cor
          <input type="color" [(ngModel)]="pendingHighlight.color">
        </label>

        <div class="actions">
          <button class="btn btn-primary" type="button" (click)="savePendingHighlight()" [disabled]="savingHighlight">
            {{ savingHighlight ? 'Salvando...' : 'Salvar marcação' }}
          </button>
          <button class="btn btn-secondary" type="button" (click)="pendingHighlight = null" [disabled]="savingHighlight">
            Cancelar
          </button>
        </div>
      </ng-container>

      <ng-template #pendingInstructions>
        <p class="muted placeholder-text">Nenhum trecho selecionado. Utilize o texto ao lado para iniciar uma nova marcação.</p>
      </ng-template>
    </div>

    <div class="highlights-list">
      <h3>Marcações desta pergunta</h3>
      <p *ngIf="questionHighlights.length === 0">Nenhuma marcação registrada para esta pergunta.</p>
      <ul *ngIf="questionHighlights.length > 0">
        <li *ngFor="let highlight of questionHighlights">
          <span class="color-dot" [style.background]="highlight.color || getTipoColor(tipo)"></span>
          <div class="highlight-body">
            <strong>"{{ highlight.text }}"</strong>
            <small *ngIf="highlight.note">{{ highlight.note }}</small>
          </div>
          <button class="btn-link" type="button" (click)="removeHighlight(highlight)" [disabled]="savingHighlight">
            Remover
          </button>
        </li>
      </ul>

      <button 
        class="btn btn-secondary" 
        type="button" 
        (click)="clearAllHighlights()" 
        [disabled]="savingHighlight || questionHighlights.length === 0">
        Limpar marcações desta pergunta
      </button>
    </div>
  </section>

  <div class="alert alert-error" *ngIf="errorMessage">
    {{ errorMessage }}
  </div>

  <div class="markdown-card" *ngIf="!errorMessage">
    <div class="markdown-container" (mouseup)="onMarkdownMouseUp()">
      <div #markdownContainer [innerHTML]="markdownHtml || ''"></div>
      <div class="markdown-placeholder" *ngIf="isLoadingMarkdown">
        <mat-spinner diameter="32"></mat-spinner>
        <span>Carregando conteúdo...</span>
      </div>
    </div>
  </div>
</div>
