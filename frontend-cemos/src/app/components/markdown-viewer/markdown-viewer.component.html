<div class="markdown-viewer">
  <!-- Modal de Confirmação para Limpar Todas as Marcações -->
  <div class="confirm-modal-overlay" *ngIf="showClearConfirmModal" (click)="cancelClearAllHighlights()">
    <div class="confirm-modal" (click)="$event.stopPropagation()">
      <h3>Confirmar Limpeza de Marcações</h3>
      <p>
        Tem certeza que deseja remover <strong>TODAS as {{ sortedGlobalHighlights.length }} marcações</strong> deste arquivo?
      </p>
      <p class="warning-text">
        ⚠️ Esta ação afetará todas as perguntas que utilizam este arquivo e <strong>não pode ser desfeita</strong>.
      </p>
      <div class="modal-actions">
        <button 
          class="btn btn-primary" 
          type="button"
          (click)="confirmClearAllHighlights()"
          [disabled]="globalActionInProgress">
          Sim, remover todas
        </button>
        <button 
          class="btn btn-secondary" 
          type="button"
          (click)="cancelClearAllHighlights()"
          [disabled]="globalActionInProgress">
          Cancelar
        </button>
      </div>
    </div>
  </div>

  <div class="top-section" *ngIf="question && !errorMessage">
    <!-- Primeira Linha: Bibliografia e Legenda lado a lado -->
    <div class="header-row">
      <section class="info-card">
        <p><strong>Bibliografia:</strong> {{ question.bibliografia_titulo || '—' }}</p>
        <p><strong>Assunto:</strong> {{ question.assunto_titulo || '—' }}</p>
        <p><strong>Arquivo Markdown:</strong> {{ question.markdown_file || 'Não configurado' }}</p>
      </section>

      <section class="legend-section">
        <h3 class="legend-title">Legenda</h3>
        <div class="legend" *ngIf="!errorMessage">
          <div class="legend-item" *ngFor="let item of legendEntries">
            <span class="color-dot" [style.background]="item.color"></span>
            <span>{{ item.label }}</span>
          </div>
        </div>
      </section>
    </div>

    <!-- Segunda Linha: Marcações existentes -->
    <section class="global-highlights" [class.is-collapsed]="!showGlobalHighlights">
    <div class="section-header">
      <div>
        <h3>Marcações existentes</h3>
        <p>Visão geral de todas as questões que utilizam este arquivo.</p>
      </div>
      <button class="btn-toggle" type="button" (click)="toggleGlobalHighlights()">
        {{ showGlobalHighlights ? 'Ocultar' : 'Mostrar' }}
      </button>
    </div>

      <div class="global-content" *ngIf="showGlobalHighlights">
      <p *ngIf="sortedGlobalHighlights.length === 0" class="muted">Nenhuma marcação cadastrada para este arquivo.</p>
      <ul class="highlights-compact-list" *ngIf="sortedGlobalHighlights.length > 0">
        <li *ngFor="let entry of sortedGlobalHighlights" class="highlight-item-compact">
          <span class="color-dot" [style.background]="getTipoColor(entry.pergunta_tipo)"></span>
          <div class="highlight-entry-compact">
            <span class="highlight-meta">
              <strong>{{ getTipoLabel(entry.pergunta_tipo) }} #{{ entry.pergunta_id }}</strong>
              <small>
                {{ entry.bibliografia_titulo || '—' }}
                <ng-container *ngIf="entry.assunto_titulo"> · {{ entry.assunto_titulo }}</ng-container>
              </small>
            </span>
            <span class="highlight-text">"{{ entry.highlight.text }}"</span>
          </div>
          <button
            *ngIf="isAdmin"
            class="btn-link-compact"
            type="button"
            (click)="removeGlobalHighlight(entry)"
            [disabled]="globalActionInProgress">
            Remover
          </button>
        </li>
      </ul>

      <div class="global-actions" *ngIf="isAdmin && sortedGlobalHighlights.length > 0">
        <button
          class="btn btn-secondary"
          type="button"
          (click)="clearAllHighlightsForPage()"
          [disabled]="globalActionInProgress"
          [attr.aria-busy]="globalActionInProgress">
          {{ globalActionInProgress && globalActionTarget === 'clear-page' ? 'Limpando...' : 'Limpar todas as marcações deste arquivo' }}
        </button>
      </div>
      </div>
    </section>
  </div>
  
  <section class="admin-section" *ngIf="isAdmin && question?.markdown_file">
    <div class="pending-highlight" [class.is-active]="!!pendingHighlight">


      <ng-container *ngIf="pendingHighlight; else pendingInstructions">
        <p class="selection-text">"{{ pendingHighlight.text }}"</p>

        <label>
          Observação
          <textarea rows="2" [(ngModel)]="pendingHighlight.note"></textarea>
        </label>

        <label>
          Cor
          <input type="color" [(ngModel)]="pendingHighlight.color">
        </label>

        <div class="actions">
          <button class="btn btn-primary" type="button" (click)="savePendingHighlight()" [disabled]="savingHighlight">
            {{ savingHighlight ? 'Salvando...' : 'Salvar marcação' }}
          </button>
          <button class="btn btn-secondary" type="button" (click)="pendingHighlight = null" [disabled]="savingHighlight">
            Cancelar
          </button>
        </div>
      </ng-container>

      <ng-template #pendingInstructions>
        <p class="muted placeholder-text">Nenhum trecho selecionado. Utilize o texto ao lado para iniciar uma nova marcação.</p>
      </ng-template>
    </div>
  </section>







  <div class="alert alert-error" *ngIf="errorMessage">
    {{ errorMessage }}
  </div>

  <div class="markdown-card" *ngIf="!errorMessage">
    <div class="markdown-container" (mouseup)="onMarkdownMouseUp()">
      <div #markdownContainer [innerHTML]="markdownHtml || ''"></div>
      <div class="markdown-placeholder" *ngIf="isLoadingMarkdown">
        <mat-spinner diameter="32"></mat-spinner>
        <span>Carregando conteúdo...</span>
      </div>
    </div>
  </div>
</div>
