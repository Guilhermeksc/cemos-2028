<div class="revisar-container">
  <div class="header">
    <div>
      <h1>Revisão de Questões</h1>
      <p class="subtitle" *ngIf="selectedMateriaId && selectedBibliografiaId && selectedAssuntoId">
        {{ getMateriaNome(selectedMateriaId) }} → {{ getBibliografiaTitulo(selectedBibliografiaId) }} → {{ getAssuntoNome(selectedAssuntoId) }}
      </p>
    </div>
    <div class="actions">
      <button class="btn btn-add" *ngIf="isAdmin" (click)="openAddQuestion()">
        Adicionar nova questão {{ getQuestaoTipoDisplay(activeTabType) }}
      </button>
      <button class="btn btn-close" (click)="closeWindow()">Fechar</button>
    </div>
  </div>

  <!-- <div *ngIf="isLoading" class="loading">
    Carregando questões...
  </div> -->

  <div *ngIf="!isLoading && errorMessage" class="error">
    {{ errorMessage }}
  </div>

  <div *ngIf="!isLoading && !errorMessage && !isAdmin" class="warning">
    Apenas administradores podem revisar e editar questões. As informações abaixo estão em modo somente leitura.
  </div>

  <div *ngIf="!isLoading && !errorMessage" class="filters-section">
    <div class="filters-grid">
      <div class="filter-item">
        <label for="materia-select">Matéria:</label>
        <select 
          id="materia-select"
          [(ngModel)]="selectedMateriaId" 
          (change)="onMateriaChange()"
          [disabled]="isLoadingMaterias || isLoading"
          class="filter-combobox"
        >
          <option [value]="null">-- Selecione uma matéria --</option>
          <option *ngFor="let materia of materiasDisponiveis" [value]="materia.id">
            {{ materia.nome }}
          </option>
        </select>
        <span *ngIf="isLoadingMaterias" class="loading-text">Carregando...</span>
      </div>

      <div class="filter-item">
        <label for="bibliografia-select">Bibliografia:</label>
        <select 
          id="bibliografia-select"
          [(ngModel)]="selectedBibliografiaId" 
          (change)="onBibliografiaChange()"
          [disabled]="isLoadingBibliografias || isLoading || !selectedMateriaId"
          class="filter-combobox"
        >
          <option [value]="null">-- Selecione uma bibliografia --</option>
          <option *ngFor="let bib of bibliografiasDisponiveis" [value]="bib.id">
            {{ bib.titulo }} {{ bib.autor ? '— ' + bib.autor : '' }}
          </option>
        </select>
        <span *ngIf="isLoadingBibliografias" class="loading-text">Carregando...</span>
      </div>

      <div class="filter-item">
        <label for="assunto-select">Assunto:</label>
        <select 
          id="assunto-select"
          [(ngModel)]="selectedAssuntoId" 
          (change)="onAssuntoChange()"
          [disabled]="isLoadingAssuntos || isLoading || !selectedBibliografiaId"
          class="filter-combobox"
          required
        >
          <option [value]="null" disabled>-- Selecione um assunto --</option>
          <option *ngFor="let assunto of assuntosDisponiveis" [value]="assunto.id">
            {{ assunto.nome }}
          </option>
        </select>
        <span *ngIf="isLoadingAssuntos" class="loading-text">Carregando...</span>
      </div>
    </div>
  </div>

  <!-- Formulário de Adicionar Questão -->
  <div *ngIf="showAddForm && isAdmin" class="add-question-form-container">
    <div class="add-question-form">
      <div class="form-header">
        <h3>Adicionar Nova Questão - {{ getQuestaoTipoDisplay(activeTabType) }}</h3>
        <button class="btn btn-small btn-close" (click)="cancelAddForm()">✕ Fechar</button>
      </div>

      <div class="form-content">
        <div class="form-grid">
          <label>
            Enunciado *
            <textarea 
              rows="3" 
              [(ngModel)]="addFormData.pergunta" 
              name="add-pergunta"
              placeholder="Digite o enunciado da questão..."
            ></textarea>
          </label>
        </div>

        <!-- Campos específicos para Múltipla Escolha -->
        <div *ngIf="activeTabType === 'multipla'" class="form-grid multipla-grid">
          <label>
            Alternativa A *
            <textarea rows="2" [(ngModel)]="addFormData.alternativa_a" name="add-alt-a"></textarea>
          </label>
          <label>
            Alternativa B *
            <textarea rows="2" [(ngModel)]="addFormData.alternativa_b" name="add-alt-b"></textarea>
          </label>
          <label>
            Alternativa C *
            <textarea rows="2" [(ngModel)]="addFormData.alternativa_c" name="add-alt-c"></textarea>
          </label>
          <label>
            Alternativa D *
            <textarea rows="2" [(ngModel)]="addFormData.alternativa_d" name="add-alt-d"></textarea>
          </label>
          <label>
            Resposta Correta *
            <select [(ngModel)]="addFormData.resposta_correta" name="add-resposta">
              <option value="a">Alternativa A</option>
              <option value="b">Alternativa B</option>
              <option value="c">Alternativa C</option>
              <option value="d">Alternativa D</option>
            </select>
          </label>
        </div>

        <!-- Campos específicos para Verdadeiro/Falso -->
        <div *ngIf="activeTabType === 'vf'" class="form-grid vf-grid">
          <label>
            Afirmação Verdadeira *
            <textarea rows="3" [(ngModel)]="addFormData.afirmacao_verdadeira" name="add-verdadeira"></textarea>
          </label>
          <label>
            Afirmação Falsa *
            <textarea rows="3" [(ngModel)]="addFormData.afirmacao_falsa" name="add-falsa"></textarea>
          </label>
          <label>
            Justificativa
            <textarea 
              rows="3" 
              [(ngModel)]="addFormData.justificativa_resposta_certa" 
              name="add-justificativa"
              placeholder="Explique por que a resposta está correta..."
            ></textarea>
          </label>
        </div>

        <!-- Campos específicos para Correlação -->
        <div *ngIf="activeTabType === 'correlacao'" class="form-grid vf-grid">
          <label>
            Coluna A (uma entrada por linha - será numerada automaticamente: 1), 2), 3)...) *
            <textarea 
              rows="4" 
              [(ngModel)]="addFormData.coluna_a_text" 
              (input)="onAddColunaAChange()"
              name="add-col-a"
              placeholder="Item 1&#10;Item 2&#10;Item 3"
            ></textarea>
                                <div class="coluna-preview" *ngIf="addFormData.coluna_a_text">
                                  <strong>Preview:</strong>
                                  <div *ngFor="let item of getColunaAItemsForPreview(addFormData.coluna_a_text); let i = index" class="preview-item">
                                    {{ i + 1 }}) {{ item }}
                                  </div>
                                </div>
                              </label>
                              <label>
                                Coluna B (uma entrada por linha - será letrada automaticamente: A), B), C)...) *
                                <textarea 
                                  rows="4" 
                                  [(ngModel)]="addFormData.coluna_b_text" 
                                  (input)="onAddColunaBChange()"
                                  name="add-col-b"
                                  placeholder="Opção A&#10;Opção B&#10;Opção C"
                                ></textarea>
                                <div class="coluna-preview" *ngIf="addFormData.coluna_b_text">
                                  <strong>Preview:</strong>
                                  <div *ngFor="let item of getColunaBItemsForPreview(addFormData.coluna_b_text); let i = index" class="preview-item">
                                    {{ getLetterForIndex(i) }}) {{ item }}
                                  </div>
                                </div>
          </label>
        </div>

        <!-- Campos específicos para Objetivas/Flashcards -->
        <div *ngIf="activeTabType === 'flashcard'" class="form-grid vf-grid">
          <label>
            Resposta *
            <textarea
              rows="4"
              [(ngModel)]="addFormData.resposta"
              name="add-flashcard-resposta"
              placeholder="Digite a resposta do flashcard..."
            ></textarea>
          </label>
          <label class="toggle-label">
            <input
              type="checkbox"
              [(ngModel)]="addFormData.prova"
              name="add-flashcard-prova"
            />
            <span>Caiu em prova</span>
          </label>
          <label class="toggle-label">
            <input
              type="checkbox"
              [(ngModel)]="addFormData.caveira"
              name="add-flashcard-caveira"
            />
            <span>Caveira</span>
          </label>
          <label>
            Ano da prova (opcional)
            <input
              type="number"
              [(ngModel)]="addFormData.ano"
              name="add-flashcard-ano"
              placeholder="Ex: 2024"
              min="1900"
              max="2100"
            />
          </label>
        </div>
        
        <!-- Mapeamento de Resposta Correta para Adicionar -->
        <div *ngIf="activeTabType === 'correlacao' && addFormData.correlacao_mappings && addFormData.correlacao_mappings.length > 0" class="correlacao-mapping">
          <h4>Resposta Correta - Relacione cada item da Coluna A com um item da Coluna B:</h4>
          <div class="mapping-list">
            <div *ngFor="let mapping of addFormData.correlacao_mappings; let i = index" class="mapping-item">
              <div class="mapping-label">
                <strong>{{ i + 1 }})</strong> {{ mapping.colunaA || '(vazio)' }}
              </div>
              <select 
                [(ngModel)]="mapping.respostaIndex"
                (ngModelChange)="updateAddCorrelacaoMapping(i, $event)"
                [name]="'add-mapping-' + i"
                class="mapping-select"
              >
                                    <option [ngValue]="null">-- Não relacionar --</option>
                                    <option *ngFor="let itemB of getAddColunaBItems(); let j = index" [ngValue]="j">
                                      {{ getLetterForIndex(j) }}) {{ itemB }}
                                    </option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Justificativa para Correlação -->
        <div *ngIf="activeTabType === 'correlacao'" class="form-grid">
          <label>
            Justificativa
            <textarea 
              rows="3" 
              [(ngModel)]="addFormData.justificativa_resposta_certa" 
              name="add-justificativa-correlacao"
              placeholder="Explique por que a resposta está correta..."
            ></textarea>
          </label>
        </div>

        <!-- Justificativa para Múltipla Escolha -->
        <div *ngIf="activeTabType === 'multipla'" class="form-grid">
          <label>
            Justificativa
            <textarea 
              rows="3" 
              [(ngModel)]="addFormData.justificativa_resposta_certa" 
              name="add-justificativa-multipla"
              placeholder="Explique por que a resposta está correta..."
            ></textarea>
          </label>
        </div>

        <div *ngIf="addError" class="add-error">
          {{ addError }}
        </div>

        <div class="form-actions">
          <button 
            class="btn btn-primary" 
            (click)="saveAddQuestion()"
            [disabled]="isSavingAdd"
          >
            {{ isSavingAdd ? 'Salvando...' : 'Salvar Questão' }}
          </button>
          <button 
            class="btn btn-secondary" 
            (click)="cancelAddForm()"
            [disabled]="isSavingAdd"
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="!isLoading && !errorMessage && bibliografiaIds.length > 0">
    <mat-tab-group [(selectedIndex)]="activeTabIndex" (selectedIndexChange)="onTabChange($event)" class="questoes-tabs">
      <mat-tab>
        <ng-template mat-tab-label>
          Múltipla Escolha
          <span class="tab-count" *ngIf="allTableData.length > 0">
            ({{ getQuestoesCountByType('multipla') }})
          </span>
        </ng-template>
        <div class="tab-content">
          <div *ngFor="let grupo of tableData" class="bibliografia-card">
            <div class="grupo-header">
              <div>
                <h2>{{ grupo.bibliografiaTitulo }}</h2>
                <p>{{ grupo.questoes.length }} {{ grupo.questoes.length === 1 ? 'questão' : 'questões' }}</p>
              </div>
            </div>

            <div class="tabela-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Páginas</th>
                    <th>Enunciado</th>
                    <th>
                      <div class="header-with-icon">
                        <img src="/assets/img/svg/star.svg" alt="Caiu em prova" class="header-icon star-icon" />
                        <span>Caiu em prova</span>
                      </div>
                    </th>
                    <th>
                      <div class="header-with-icon">
                        <img src="/assets/img/svg/danger.svg" alt="Caveira" class="header-icon danger-icon" />
                        <span>Caveira</span>
                      </div>
                    </th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody>
                  <ng-container *ngFor="let questao of grupo.questoes">
                    <tr [class.editing-row]="isEditing(questao)" [class.row-caiu-prova]="questao.caiu_em_prova && !questao.caveira" [class.row-caveira]="questao.caveira">
                      <td>#{{ questao.id }}</td>
                      <td>
                        <div>{{ getPaginasDisplay(questao) }}</div>
                        <ng-container *ngIf="isAdmin">
                          <ng-container *ngIf="!isEditingPaginas(questao)">
                            <button class="btn btn-icon btn-paginas" (click)="startEditingPaginas(questao)" title="Editar páginas">
                              <img src="/assets/img/svg/pilha-de-livros.svg" alt="Páginas" class="btn-icon-img" />
                            </button>
                          </ng-container>
                          <div class="cell-edit-inline" *ngIf="isEditingPaginas(questao)">
                            <input 
                              type="text" 
                              [(ngModel)]="paginasInput" 
                              [name]="'paginas-' + questao.id"
                              placeholder="Ex: 45-50"
                              maxlength="100"
                              class="paginas-input"
                            />
                            <button class="btn btn-small btn-save" (click)="savePaginas(questao)" [disabled]="togglingPaginas.has(questao.uniqueKey)">
                              {{ togglingPaginas.has(questao.uniqueKey) ? '...' : 'Salvar' }}
                            </button>
                            <button class="btn btn-small" (click)="cancelEditingPaginas()" [disabled]="togglingPaginas.has(questao.uniqueKey)">
                              Cancelar
                            </button>
                          </div>
                        </ng-container>
                      </td>
                      <td>
                        <div class="pergunta-texto">{{ questao.pergunta }}</div>
                        <ng-container *ngIf="questao.tipo === 'vf'">
                          <div class="pergunta-assertivas" *ngIf="$any(questao.data)?.afirmacao_verdadeira || $any(questao.data)?.afirmacao_falsa">
                            <div class="assertiva assertiva-verdadeira" *ngIf="$any(questao.data)?.afirmacao_verdadeira">
                              <span class="assertiva-label">V:</span> {{ $any(questao.data)?.afirmacao_verdadeira }}
                            </div>
                            <div class="assertiva assertiva-falsa" *ngIf="$any(questao.data)?.afirmacao_falsa">
                              <span class="assertiva-label">F:</span> {{ $any(questao.data)?.afirmacao_falsa }}
                            </div>
                          </div>
                        </ng-container>
                        <ng-container *ngIf="questao.tipo === 'multipla'">
                          <div class="pergunta-alternativas" *ngIf="$any(questao.data)?.alternativa_a || $any(questao.data)?.alternativa_b || $any(questao.data)?.alternativa_c || $any(questao.data)?.alternativa_d">
                            <div class="alternativa" *ngIf="$any(questao.data)?.alternativa_a">A) {{ $any(questao.data)?.alternativa_a }}</div>
                            <div class="alternativa" *ngIf="$any(questao.data)?.alternativa_b">B) {{ $any(questao.data)?.alternativa_b }}</div>
                            <div class="alternativa" *ngIf="$any(questao.data)?.alternativa_c">C) {{ $any(questao.data)?.alternativa_c }}</div>
                            <div class="alternativa" *ngIf="$any(questao.data)?.alternativa_d">D) {{ $any(questao.data)?.alternativa_d }}</div>
                            <div class="resposta-certa" *ngIf="$any(questao.data)?.resposta_correta">
                              Resposta: {{ $any(questao.data)?.resposta_correta?.toUpperCase() }}) {{ getAlternativaByLetra(questao, $any(questao.data)?.resposta_correta) }}
                            </div>
                          </div>
                        </ng-container>
                        <ng-container *ngIf="questao.tipo === 'correlacao'">
                          <div class="pergunta-correlacao" *ngIf="getColunaAFromRow(questao)?.length || getColunaBFromRow(questao)?.length">
                            <div class="correlacao-coluna">
                              <span class="correlacao-label">Coluna A:</span>
                              <div class="correlacao-item" *ngFor="let item of getColunaAFromRow(questao); let i = index">{{ i + 1 }}) {{ item }}</div>
                            </div>
                            <div class="correlacao-coluna">
                              <span class="correlacao-label">Coluna B:</span>
                              <div class="correlacao-item" *ngFor="let item of getColunaBFromRow(questao); let i = index">{{ getLetterForIndex(i) }}) {{ item }}</div>
                            </div>
                            <div class="correlacao-resposta" *ngIf="getCorrelacaoMappingsDisplay(questao)?.length">
                              <span class="correlacao-label">Resposta:</span>
                              <div class="correlacao-mapping-item" *ngFor="let m of getCorrelacaoMappingsDisplay(questao)">{{ m }}</div>
                            </div>
                          </div>
                        </ng-container>
                        <div class="pergunta-justificativa" *ngIf="questao.justificativa_resposta_certa">
                          Justificativa: {{ questao.justificativa_resposta_certa }}
                        </div>
                      </td>
                      <td>
                        <label class="toggle-label" *ngIf="isAdmin">
                          <input 
                            type="checkbox" 
                            [checked]="questao.caiu_em_prova"
                            (change)="onToggleCaiuEmProva(questao, $event.target.checked)"
                            [disabled]="togglingCaiuEmProva.has(questao.uniqueKey)"
                          />
                          <span>{{ togglingCaiuEmProva.has(questao.uniqueKey) ? 'Atualizando...' : questao.caiu_em_prova ? 'Sim' : 'Não' }}</span>
                        </label>
                        <span *ngIf="!isAdmin">{{ questao.caiu_em_prova ? 'Sim' : 'Não' }}</span>
                        <ng-container *ngIf="isAdmin && questao.caiu_em_prova">
                          <ng-container *ngIf="!isEditingAno(questao)">
                            <button class="btn btn-icon btn-ano" (click)="startEditingAno(questao)" [title]="'Editar ano' + (questao.ano_prova ? ' (' + questao.ano_prova + ')' : '')">
                              <img src="/assets/img/svg/calendar.svg" alt="Ano" class="btn-icon-img" />
                            </button>
                          </ng-container>
                          <div class="cell-edit-inline" *ngIf="isEditingAno(questao)">
                            <input 
                              type="number" 
                              [(ngModel)]="anoProvaInput" 
                              [name]="'ano-' + questao.id"
                              placeholder="Ex: 2024"
                              min="1900"
                              max="2100"
                              class="ano-input"
                            />
                            <button class="btn btn-small btn-save" (click)="saveAnoProva(questao)" [disabled]="togglingAnoProva.has(questao.uniqueKey)">
                              {{ togglingAnoProva.has(questao.uniqueKey) ? '...' : 'Salvar' }}
                            </button>
                            <button class="btn btn-small" (click)="cancelEditingAno()" [disabled]="togglingAnoProva.has(questao.uniqueKey)">
                              Cancelar
                            </button>
                          </div>
                        </ng-container>
                      </td>
                      <td>
                        <label class="toggle-label" *ngIf="isAdmin">
                          <input 
                            type="checkbox" 
                            [checked]="questao.caveira"
                            (change)="onToggleCaveira(questao, $event.target.checked)"
                            [disabled]="togglingCaveira.has(questao.uniqueKey)"
                          />
                          <span>{{ togglingCaveira.has(questao.uniqueKey) ? 'Atualizando...' : questao.caveira ? 'Sim' : 'Não' }}</span>
                        </label>
                        <span *ngIf="!isAdmin">{{ questao.caveira ? 'Sim' : 'Não' }}</span>
                      </td>
                      <td class="actions-cell">
                        <button class="btn btn-small" *ngIf="isAdmin" (click)="startEditingRow(questao)">
                          {{ isEditing(questao) ? 'Editando...' : 'Editar' }}
                        </button>
                      </td>
                    </tr>
                    <tr *ngIf="isEditing(questao)">
                      <td colspan="6">
                        <div class="edit-form">
                          <div class="edit-form-header">
                            <img src="/assets/img/svg/edit.svg" alt="Editar" class="edit-form-icon" />
                            <span>Editando questão #{{ questao.id }}</span>
                          </div>
                          <!-- Formulário específico para Múltipla Escolha -->
                          <div *ngIf="questao.tipo === 'multipla'">
                            <div class="form-grid form-grid-single">
                              <label>
                                Enunciado
                                <textarea 
                                  rows="3" 
                                  [(ngModel)]="editingFormData.pergunta" 
                                  name="pergunta-{{ questao.id }}"
                                ></textarea>
                              </label>
                              <label>
                                Páginas
                                <input 
                                  type="text" 
                                  [(ngModel)]="editingFormData.paginas" 
                                  name="paginas-{{ questao.id }}"
                                  placeholder="Ex: 45-50"
                                  maxlength="100"
                                />
                              </label>
                            </div>
                            <div class="form-grid multipla-grid">
                            <label>
                              Alternativa A
                              <textarea rows="2" [(ngModel)]="editingFormData.alternativa_a" name="mult-a-{{ questao.id }}"></textarea>
                            </label>
                            <label>
                              Alternativa B
                              <textarea rows="2" [(ngModel)]="editingFormData.alternativa_b" name="mult-b-{{ questao.id }}"></textarea>
                            </label>
                            <label>
                              Alternativa C
                              <textarea rows="2" [(ngModel)]="editingFormData.alternativa_c" name="mult-c-{{ questao.id }}"></textarea>
                            </label>
                            <label>
                              Alternativa D
                              <textarea rows="2" [(ngModel)]="editingFormData.alternativa_d" name="mult-d-{{ questao.id }}"></textarea>
                            </label>
                            <label>
                              Resposta Correta
                              <select [(ngModel)]="editingFormData.resposta_correta" name="resp-{{ questao.id }}">
                                <option value="a">A</option>
                                <option value="b">B</option>
                                <option value="c">C</option>
                                <option value="d">D</option>
                              </select>
                            </label>
                            </div>
                            <div class="form-grid">
                              <label>
                                Justificativa
                                <textarea 
                                  rows="3" 
                                  [(ngModel)]="editingFormData.justificativa_resposta_certa" 
                                  name="just-{{ questao.id }}"
                                ></textarea>
                              </label>
                            </div>
                          </div>

                          <!-- Formulário específico para V/F -->
                          <div *ngIf="questao.tipo === 'vf'" class="form-grid vf-grid">
                            <label>
                              Enunciado
                              <textarea 
                                rows="3" 
                                [(ngModel)]="editingFormData.pergunta" 
                                name="pergunta-{{ questao.id }}"
                              ></textarea>
                            </label>
                            <label>
                              Páginas
                              <input 
                                type="text" 
                                [(ngModel)]="editingFormData.paginas" 
                                name="paginas-vf-{{ questao.id }}"
                                placeholder="Ex: 45-50"
                                maxlength="100"
                              />
                            </label>
                            <label>
                              Afirmação Verdadeira
                              <textarea rows="2" [(ngModel)]="editingFormData.afirmacao_verdadeira" name="vf-v-{{ questao.id }}"></textarea>
                            </label>
                            <label>
                              Afirmação Falsa
                              <textarea rows="2" [(ngModel)]="editingFormData.afirmacao_falsa" name="vf-f-{{ questao.id }}"></textarea>
                            </label>
                            <label>
                              Justificativa
                              <textarea 
                                rows="3" 
                                [(ngModel)]="editingFormData.justificativa_resposta_certa" 
                                name="just-{{ questao.id }}"
                              ></textarea>
                            </label>
                          </div>

                          <!-- Formulário específico para Correlação -->
                          <div *ngIf="questao.tipo === 'correlacao'">
                            <div class="form-grid form-grid-single">
                              <label>
                                Enunciado
                                <textarea 
                                  rows="3" 
                                  [(ngModel)]="editingFormData.pergunta" 
                                  name="pergunta-{{ questao.id }}"
                                ></textarea>
                              </label>
                              <label>
                                Páginas
                                <input 
                                  type="text" 
                                  [(ngModel)]="editingFormData.paginas" 
                                  name="paginas-cor-{{ questao.id }}"
                                  placeholder="Ex: 45-50"
                                  maxlength="100"
                                />
                              </label>
                            </div>
                            <div class="form-grid form-grid-single">
                              <label>
                                Coluna A (uma linha por item - será numerada automaticamente: 1), 2), 3)...)
                                <textarea 
                                  rows="4" 
                                  [(ngModel)]="editingFormData.coluna_a_text" 
                                  (input)="onColunaAChange(questao.uniqueKey)"
                                  name="cor-a-{{ questao.id }}"
                                  placeholder="Item 1&#10;Item 2&#10;Item 3"
                                ></textarea>
                                <div class="coluna-preview" *ngIf="editingFormData.coluna_a_text">
                                  <strong>Preview:</strong>
                                  <div *ngFor="let item of getColunaAItemsForPreview(editingFormData.coluna_a_text); let i = index" class="preview-item">
                                    {{ i + 1 }}) {{ item }}
                                  </div>
                                </div>
                              </label>
                              <label>
                                Coluna B (uma linha por item - será letrada automaticamente: A), B), C)...)
                                <textarea 
                                  rows="4" 
                                  [(ngModel)]="editingFormData.coluna_b_text" 
                                  (input)="onColunaBChange(questao.uniqueKey)"
                                  name="cor-b-{{ questao.id }}"
                                  placeholder="Opção A&#10;Opção B&#10;Opção C"
                                ></textarea>
                                <div class="coluna-preview" *ngIf="editingFormData.coluna_b_text">
                                  <strong>Preview:</strong>
                                  <div *ngFor="let item of getColunaBItemsForPreview(editingFormData.coluna_b_text); let i = index" class="preview-item">
                                    {{ getLetterForIndex(i) }}) {{ item }}
                                  </div>
                                </div>
                              </label>
                            </div>
                            
                            <!-- Mapeamento de Resposta Correta -->
                            <div class="correlacao-mapping" *ngIf="editingFormData.correlacao_mappings && editingFormData.correlacao_mappings.length > 0">
                              <h4>Resposta Correta - Relacione cada item da Coluna A com um item da Coluna B:</h4>
                              <div class="mapping-list">
                                <div *ngFor="let mapping of editingFormData.correlacao_mappings; let i = index" class="mapping-item">
                                  <div class="mapping-label">
                                    <strong>{{ i + 1 }})</strong> {{ mapping.colunaA || '(vazio)' }}
                                  </div>
                                  <select 
                                    [(ngModel)]="mapping.respostaIndex"
                                    (ngModelChange)="updateCorrelacaoMapping(i, $event)"
                                    [name]="'mapping-' + questao.id + '-' + i"
                                    class="mapping-select"
                                  >
                                    <option [ngValue]="null">-- Não relacionar --</option>
                                    <option *ngFor="let itemB of getColunaBItems(); let j = index" [ngValue]="j">
                                      {{ getLetterForIndex(j) }}) {{ itemB }}
                                    </option>
                                  </select>
                                </div>
                              </div>
                            </div>
                            <div class="form-grid">
                              <label>
                                Justificativa
                                <textarea 
                                  rows="3" 
                                  [(ngModel)]="editingFormData.justificativa_resposta_certa" 
                                  name="just-{{ questao.id }}"
                                ></textarea>
                              </label>
                            </div>
                          </div>

                          <div *ngIf="editError" class="edit-error">
                            {{ editError }}
                          </div>

                          <div class="edit-actions">
                            <div class="edit-actions-left">
                              <button class="btn btn-small btn-save" (click)="saveEditingRow(questao)" [disabled]="isSavingEdit">
                                {{ isSavingEdit ? 'Salvando...' : 'Salvar' }}
                              </button>
                              <button class="btn btn-small" type="button" (click)="cancelEditing()" [disabled]="isSavingEdit">
                                Cancelar
                              </button>
                            </div>
                            <div class="edit-actions-right">
                              <button class="btn btn-small btn-delete" type="button" (click)="confirmDeleteQuestion(questao)" [disabled]="isSavingEdit">
                                Excluir
                              </button>
                            </div>
                          </div>
                        </div>
                      </td>
                    </tr>
                  </ng-container>
                </tbody>
              </table>
            </div>
          </div>

          <div *ngIf="tableData.length === 0" class="empty">
            Nenhuma questão de múltipla escolha encontrada para as bibliografias selecionadas.
          </div>
        </div>
      </mat-tab>

      <mat-tab>
        <ng-template mat-tab-label>
          Verdadeiro/Falso
          <span class="tab-count" *ngIf="allTableData.length > 0">
            ({{ getQuestoesCountByType('vf') }})
          </span>
        </ng-template>
        <div class="tab-content">
          <div *ngFor="let grupo of tableData" class="bibliografia-card">
            <div class="grupo-header">
              <div>
                <h2>{{ grupo.bibliografiaTitulo }}</h2>
                <p>{{ grupo.questoes.length }} {{ grupo.questoes.length === 1 ? 'questão' : 'questões' }}</p>
              </div>
            </div>

            <div class="tabela-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Páginas</th>
                    <th>Enunciado</th>
                    <th>
                      <div class="header-with-icon">
                        <img src="/assets/img/svg/star.svg" alt="Caiu em prova" class="header-icon star-icon" />
                        <span>Caiu em prova</span>
                      </div>
                    </th>
                    <th>
                      <div class="header-with-icon">
                        <img src="/assets/img/svg/danger.svg" alt="Caveira" class="header-icon danger-icon" />
                        <span>Caveira</span>
                      </div>
                    </th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody>
                  <ng-container *ngFor="let questao of grupo.questoes">
                    <tr [class.editing-row]="isEditing(questao)" [class.row-caiu-prova]="questao.caiu_em_prova && !questao.caveira" [class.row-caveira]="questao.caveira">
                      <td>#{{ questao.id }}</td>
                      <td>
                        <div>{{ getPaginasDisplay(questao) }}</div>
                        <ng-container *ngIf="isAdmin">
                          <ng-container *ngIf="!isEditingPaginas(questao)">
                            <button class="btn btn-icon btn-paginas" (click)="startEditingPaginas(questao)" title="Editar páginas">
                              <img src="/assets/img/svg/pilha-de-livros.svg" alt="Páginas" class="btn-icon-img" />
                            </button>
                          </ng-container>
                          <div class="cell-edit-inline" *ngIf="isEditingPaginas(questao)">
                            <input 
                              type="text" 
                              [(ngModel)]="paginasInput" 
                              [name]="'paginas-' + questao.id"
                              placeholder="Ex: 45-50"
                              maxlength="100"
                              class="paginas-input"
                            />
                            <button class="btn btn-small btn-save" (click)="savePaginas(questao)" [disabled]="togglingPaginas.has(questao.uniqueKey)">
                              {{ togglingPaginas.has(questao.uniqueKey) ? '...' : 'Salvar' }}
                            </button>
                            <button class="btn btn-small" (click)="cancelEditingPaginas()" [disabled]="togglingPaginas.has(questao.uniqueKey)">
                              Cancelar
                            </button>
                          </div>
                        </ng-container>
                      </td>
                      <td>
                        <div class="pergunta-texto">{{ questao.pergunta }}</div>
                        <ng-container *ngIf="questao.tipo === 'vf'">
                          <div class="pergunta-assertivas" *ngIf="$any(questao.data)?.afirmacao_verdadeira || $any(questao.data)?.afirmacao_falsa">
                            <div class="assertiva assertiva-verdadeira" *ngIf="$any(questao.data)?.afirmacao_verdadeira">
                              <span class="assertiva-label">V:</span> {{ $any(questao.data)?.afirmacao_verdadeira }}
                            </div>
                            <div class="assertiva assertiva-falsa" *ngIf="$any(questao.data)?.afirmacao_falsa">
                              <span class="assertiva-label">F:</span> {{ $any(questao.data)?.afirmacao_falsa }}
                            </div>
                          </div>
                        </ng-container>
                        <ng-container *ngIf="questao.tipo === 'multipla'">
                          <div class="pergunta-alternativas" *ngIf="$any(questao.data)?.alternativa_a || $any(questao.data)?.alternativa_b || $any(questao.data)?.alternativa_c || $any(questao.data)?.alternativa_d">
                            <div class="alternativa" *ngIf="$any(questao.data)?.alternativa_a">A) {{ $any(questao.data)?.alternativa_a }}</div>
                            <div class="alternativa" *ngIf="$any(questao.data)?.alternativa_b">B) {{ $any(questao.data)?.alternativa_b }}</div>
                            <div class="alternativa" *ngIf="$any(questao.data)?.alternativa_c">C) {{ $any(questao.data)?.alternativa_c }}</div>
                            <div class="alternativa" *ngIf="$any(questao.data)?.alternativa_d">D) {{ $any(questao.data)?.alternativa_d }}</div>
                            <div class="resposta-certa" *ngIf="$any(questao.data)?.resposta_correta">
                              Resposta: {{ $any(questao.data)?.resposta_correta?.toUpperCase() }}) {{ getAlternativaByLetra(questao, $any(questao.data)?.resposta_correta) }}
                            </div>
                          </div>
                        </ng-container>
                        <ng-container *ngIf="questao.tipo === 'correlacao'">
                          <div class="pergunta-correlacao" *ngIf="getColunaAFromRow(questao)?.length || getColunaBFromRow(questao)?.length">
                            <div class="correlacao-coluna">
                              <span class="correlacao-label">Coluna A:</span>
                              <div class="correlacao-item" *ngFor="let item of getColunaAFromRow(questao); let i = index">{{ i + 1 }}) {{ item }}</div>
                            </div>
                            <div class="correlacao-coluna">
                              <span class="correlacao-label">Coluna B:</span>
                              <div class="correlacao-item" *ngFor="let item of getColunaBFromRow(questao); let i = index">{{ getLetterForIndex(i) }}) {{ item }}</div>
                            </div>
                            <div class="correlacao-resposta" *ngIf="getCorrelacaoMappingsDisplay(questao)?.length">
                              <span class="correlacao-label">Resposta:</span>
                              <div class="correlacao-mapping-item" *ngFor="let m of getCorrelacaoMappingsDisplay(questao)">{{ m }}</div>
                            </div>
                          </div>
                        </ng-container>
                        <div class="pergunta-justificativa" *ngIf="questao.justificativa_resposta_certa">
                          Justificativa: {{ questao.justificativa_resposta_certa }}
                        </div>
                      </td>
                      <td>
                        <label class="toggle-label" *ngIf="isAdmin">
                          <input 
                            type="checkbox" 
                            [checked]="questao.caiu_em_prova"
                            (change)="onToggleCaiuEmProva(questao, $event.target.checked)"
                            [disabled]="togglingCaiuEmProva.has(questao.uniqueKey)"
                          />
                          <span>{{ togglingCaiuEmProva.has(questao.uniqueKey) ? 'Atualizando...' : questao.caiu_em_prova ? 'Sim' : 'Não' }}</span>
                        </label>
                        <span *ngIf="!isAdmin">{{ questao.caiu_em_prova ? 'Sim' : 'Não' }}</span>
                        <ng-container *ngIf="isAdmin && questao.caiu_em_prova">
                          <ng-container *ngIf="!isEditingAno(questao)">
                            <button class="btn btn-icon btn-ano" (click)="startEditingAno(questao)" [title]="'Editar ano' + (questao.ano_prova ? ' (' + questao.ano_prova + ')' : '')">
                              <img src="/assets/img/svg/calendar.svg" alt="Ano" class="btn-icon-img" />
                            </button>
                          </ng-container>
                          <div class="cell-edit-inline" *ngIf="isEditingAno(questao)">
                            <input 
                              type="number" 
                              [(ngModel)]="anoProvaInput" 
                              [name]="'ano-' + questao.id"
                              placeholder="Ex: 2024"
                              min="1900"
                              max="2100"
                              class="ano-input"
                            />
                            <button class="btn btn-small btn-save" (click)="saveAnoProva(questao)" [disabled]="togglingAnoProva.has(questao.uniqueKey)">
                              {{ togglingAnoProva.has(questao.uniqueKey) ? '...' : 'Salvar' }}
                            </button>
                            <button class="btn btn-small" (click)="cancelEditingAno()" [disabled]="togglingAnoProva.has(questao.uniqueKey)">
                              Cancelar
                            </button>
                          </div>
                        </ng-container>
                      </td>
                      <td>
                        <label class="toggle-label" *ngIf="isAdmin">
                          <input 
                            type="checkbox" 
                            [checked]="questao.caveira"
                            (change)="onToggleCaveira(questao, $event.target.checked)"
                            [disabled]="togglingCaveira.has(questao.uniqueKey)"
                          />
                          <span>{{ togglingCaveira.has(questao.uniqueKey) ? 'Atualizando...' : questao.caveira ? 'Sim' : 'Não' }}</span>
                        </label>
                        <span *ngIf="!isAdmin">{{ questao.caveira ? 'Sim' : 'Não' }}</span>
                      </td>
                      <td class="actions-cell">
                        <button class="btn btn-small" *ngIf="isAdmin" (click)="startEditingRow(questao)">
                          {{ isEditing(questao) ? 'Editando...' : 'Editar' }}
                        </button>
                      </td>
                    </tr>
                    <tr *ngIf="isEditing(questao)">
                      <td colspan="6">
                        <div class="edit-form">
                          <div class="edit-form-header">
                            <img src="/assets/img/svg/edit.svg" alt="Editar" class="edit-form-icon" />
                            <span>Editando questão #{{ questao.id }}</span>
                          </div>
                          <!-- Formulário específico para Múltipla Escolha -->
                          <div *ngIf="questao.tipo === 'multipla'">
                            <div class="form-grid form-grid-single">
                              <label>
                                Enunciado
                                <textarea 
                                  rows="3" 
                                  [(ngModel)]="editingFormData.pergunta" 
                                  name="pergunta-{{ questao.id }}"
                                ></textarea>
                              </label>
                              <label>
                                Páginas
                                <input 
                                  type="text" 
                                  [(ngModel)]="editingFormData.paginas" 
                                  name="paginas-{{ questao.id }}"
                                  placeholder="Ex: 45-50"
                                  maxlength="100"
                                />
                              </label>
                            </div>
                            <div class="form-grid multipla-grid">
                            <label>
                              Alternativa A
                              <textarea rows="2" [(ngModel)]="editingFormData.alternativa_a" name="mult-a-{{ questao.id }}"></textarea>
                            </label>
                            <label>
                              Alternativa B
                              <textarea rows="2" [(ngModel)]="editingFormData.alternativa_b" name="mult-b-{{ questao.id }}"></textarea>
                            </label>
                            <label>
                              Alternativa C
                              <textarea rows="2" [(ngModel)]="editingFormData.alternativa_c" name="mult-c-{{ questao.id }}"></textarea>
                            </label>
                            <label>
                              Alternativa D
                              <textarea rows="2" [(ngModel)]="editingFormData.alternativa_d" name="mult-d-{{ questao.id }}"></textarea>
                            </label>
                            <label>
                              Resposta Correta
                              <select [(ngModel)]="editingFormData.resposta_correta" name="resp-{{ questao.id }}">
                                <option value="a">A</option>
                                <option value="b">B</option>
                                <option value="c">C</option>
                                <option value="d">D</option>
                              </select>
                            </label>
                            </div>
                            <div class="form-grid">
                              <label>
                                Justificativa
                                <textarea 
                                  rows="3" 
                                  [(ngModel)]="editingFormData.justificativa_resposta_certa" 
                                  name="just-{{ questao.id }}"
                                ></textarea>
                              </label>
                            </div>
                          </div>

                          <!-- Formulário específico para V/F -->
                          <div *ngIf="questao.tipo === 'vf'" class="form-grid vf-grid">
                            <label>
                              Enunciado
                              <textarea 
                                rows="3" 
                                [(ngModel)]="editingFormData.pergunta" 
                                name="pergunta-{{ questao.id }}"
                              ></textarea>
                            </label>
                            <label>
                              Páginas
                              <input 
                                type="text" 
                                [(ngModel)]="editingFormData.paginas" 
                                name="paginas-vf-{{ questao.id }}"
                                placeholder="Ex: 45-50"
                                maxlength="100"
                              />
                            </label>
                            <label>
                              Afirmação Verdadeira
                              <textarea rows="2" [(ngModel)]="editingFormData.afirmacao_verdadeira" name="vf-v-{{ questao.id }}"></textarea>
                            </label>
                            <label>
                              Afirmação Falsa
                              <textarea rows="2" [(ngModel)]="editingFormData.afirmacao_falsa" name="vf-f-{{ questao.id }}"></textarea>
                            </label>
                            <label>
                              Justificativa
                              <textarea 
                                rows="3" 
                                [(ngModel)]="editingFormData.justificativa_resposta_certa" 
                                name="just-{{ questao.id }}"
                              ></textarea>
                            </label>
                          </div>

                          <!-- Formulário específico para Correlação -->
                          <div *ngIf="questao.tipo === 'correlacao'">
                            <div class="form-grid form-grid-single">
                              <label>
                                Enunciado
                                <textarea 
                                  rows="3" 
                                  [(ngModel)]="editingFormData.pergunta" 
                                  name="pergunta-{{ questao.id }}"
                                ></textarea>
                              </label>
                              <label>
                                Páginas
                                <input 
                                  type="text" 
                                  [(ngModel)]="editingFormData.paginas" 
                                  name="paginas-cor-{{ questao.id }}"
                                  placeholder="Ex: 45-50"
                                  maxlength="100"
                                />
                              </label>
                            </div>
                            <div class="form-grid form-grid-single">
                              <label>
                                Coluna A (uma linha por item - será numerada automaticamente: 1), 2), 3)...)
                                <textarea 
                                  rows="4" 
                                  [(ngModel)]="editingFormData.coluna_a_text" 
                                  (input)="onColunaAChange(questao.uniqueKey)"
                                  name="cor-a-{{ questao.id }}"
                                  placeholder="Item 1&#10;Item 2&#10;Item 3"
                                ></textarea>
                                <div class="coluna-preview" *ngIf="editingFormData.coluna_a_text">
                                  <strong>Preview:</strong>
                                  <div *ngFor="let item of getColunaAItemsForPreview(editingFormData.coluna_a_text); let i = index" class="preview-item">
                                    {{ i + 1 }}) {{ item }}
                                  </div>
                                </div>
                              </label>
                              <label>
                                Coluna B (uma linha por item - será letrada automaticamente: A), B), C)...)
                                <textarea 
                                  rows="4" 
                                  [(ngModel)]="editingFormData.coluna_b_text" 
                                  (input)="onColunaBChange(questao.uniqueKey)"
                                  name="cor-b-{{ questao.id }}"
                                  placeholder="Opção A&#10;Opção B&#10;Opção C"
                                ></textarea>
                                <div class="coluna-preview" *ngIf="editingFormData.coluna_b_text">
                                  <strong>Preview:</strong>
                                  <div *ngFor="let item of getColunaBItemsForPreview(editingFormData.coluna_b_text); let i = index" class="preview-item">
                                    {{ getLetterForIndex(i) }}) {{ item }}
                                  </div>
                                </div>
                              </label>
                            </div>
                            
                            <!-- Mapeamento de Resposta Correta -->
                            <div class="correlacao-mapping" *ngIf="editingFormData.correlacao_mappings && editingFormData.correlacao_mappings.length > 0">
                              <h4>Resposta Correta - Relacione cada item da Coluna A com um item da Coluna B:</h4>
                              <div class="mapping-list">
                                <div *ngFor="let mapping of editingFormData.correlacao_mappings; let i = index" class="mapping-item">
                                  <div class="mapping-label">
                                    <strong>{{ i + 1 }})</strong> {{ mapping.colunaA || '(vazio)' }}
                                  </div>
                                  <select 
                                    [(ngModel)]="mapping.respostaIndex"
                                    (ngModelChange)="updateCorrelacaoMapping(i, $event)"
                                    [name]="'mapping-' + questao.id + '-' + i"
                                    class="mapping-select"
                                  >
                                    <option [ngValue]="null">-- Não relacionar --</option>
                                    <option *ngFor="let itemB of getColunaBItems(); let j = index" [ngValue]="j">
                                      {{ getLetterForIndex(j) }}) {{ itemB }}
                                    </option>
                                  </select>
                                </div>
                              </div>
                            </div>
                            <div class="form-grid">
                              <label>
                                Justificativa
                                <textarea 
                                  rows="3" 
                                  [(ngModel)]="editingFormData.justificativa_resposta_certa" 
                                  name="just-{{ questao.id }}"
                                ></textarea>
                              </label>
                            </div>
                          </div>

                          <div *ngIf="editError" class="edit-error">
                            {{ editError }}
                          </div>

                          <div class="edit-actions">
                            <div class="edit-actions-left">
                              <button class="btn btn-small btn-save" (click)="saveEditingRow(questao)" [disabled]="isSavingEdit">
                                {{ isSavingEdit ? 'Salvando...' : 'Salvar' }}
                              </button>
                              <button class="btn btn-small" type="button" (click)="cancelEditing()" [disabled]="isSavingEdit">
                                Cancelar
                              </button>
                            </div>
                            <div class="edit-actions-right">
                              <button class="btn btn-small btn-delete" type="button" (click)="confirmDeleteQuestion(questao)" [disabled]="isSavingEdit">
                                Excluir
                              </button>
                            </div>
                          </div>
                        </div>
                      </td>
                    </tr>
                  </ng-container>
                </tbody>
              </table>
            </div>
          </div>

          <div *ngIf="tableData.length === 0" class="empty">
            Nenhuma questão verdadeiro/falso encontrada para as bibliografias selecionadas.
          </div>
        </div>
      </mat-tab>

      <mat-tab>
        <ng-template mat-tab-label>
          Correlação
          <span class="tab-count" *ngIf="allTableData.length > 0">
            ({{ getQuestoesCountByType('correlacao') }})
          </span>
        </ng-template>
        <div class="tab-content">
          <div *ngFor="let grupo of tableData" class="bibliografia-card">
            <div class="grupo-header">
              <div>
                <h2>{{ grupo.bibliografiaTitulo }}</h2>
                <p>{{ grupo.questoes.length }} {{ grupo.questoes.length === 1 ? 'questão' : 'questões' }}</p>
              </div>
            </div>

            <div class="tabela-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Páginas</th>
                    <th>Enunciado</th>
                    <th>
                      <div class="header-with-icon">
                        <img src="/assets/img/svg/star.svg" alt="Caiu em prova" class="header-icon star-icon" />
                        <span>Caiu em prova</span>
                      </div>
                    </th>
                    <th>
                      <div class="header-with-icon">
                        <img src="/assets/img/svg/danger.svg" alt="Caveira" class="header-icon danger-icon" />
                        <span>Caveira</span>
                      </div>
                    </th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody>
                  <ng-container *ngFor="let questao of grupo.questoes">
                    <tr [class.editing-row]="isEditing(questao)" [class.row-caiu-prova]="questao.caiu_em_prova && !questao.caveira" [class.row-caveira]="questao.caveira">
                      <td>#{{ questao.id }}</td>
                      <td>
                        <div>{{ getPaginasDisplay(questao) }}</div>
                        <ng-container *ngIf="isAdmin">
                          <ng-container *ngIf="!isEditingPaginas(questao)">
                            <button class="btn btn-icon btn-paginas" (click)="startEditingPaginas(questao)" title="Editar páginas">
                              <img src="/assets/img/svg/pilha-de-livros.svg" alt="Páginas" class="btn-icon-img" />
                            </button>
                          </ng-container>
                          <div class="cell-edit-inline" *ngIf="isEditingPaginas(questao)">
                            <input 
                              type="text" 
                              [(ngModel)]="paginasInput" 
                              [name]="'paginas-' + questao.id"
                              placeholder="Ex: 45-50"
                              maxlength="100"
                              class="paginas-input"
                            />
                            <button class="btn btn-small btn-save" (click)="savePaginas(questao)" [disabled]="togglingPaginas.has(questao.uniqueKey)">
                              {{ togglingPaginas.has(questao.uniqueKey) ? '...' : 'Salvar' }}
                            </button>
                            <button class="btn btn-small" (click)="cancelEditingPaginas()" [disabled]="togglingPaginas.has(questao.uniqueKey)">
                              Cancelar
                            </button>
                          </div>
                        </ng-container>
                      </td>
                      <td>
                        <div class="pergunta-texto">{{ questao.pergunta }}</div>
                        <ng-container *ngIf="questao.tipo === 'vf'">
                          <div class="pergunta-assertivas" *ngIf="$any(questao.data)?.afirmacao_verdadeira || $any(questao.data)?.afirmacao_falsa">
                            <div class="assertiva assertiva-verdadeira" *ngIf="$any(questao.data)?.afirmacao_verdadeira">
                              <span class="assertiva-label">V:</span> {{ $any(questao.data)?.afirmacao_verdadeira }}
                            </div>
                            <div class="assertiva assertiva-falsa" *ngIf="$any(questao.data)?.afirmacao_falsa">
                              <span class="assertiva-label">F:</span> {{ $any(questao.data)?.afirmacao_falsa }}
                            </div>
                          </div>
                        </ng-container>
                        <ng-container *ngIf="questao.tipo === 'multipla'">
                          <div class="pergunta-alternativas" *ngIf="$any(questao.data)?.alternativa_a || $any(questao.data)?.alternativa_b || $any(questao.data)?.alternativa_c || $any(questao.data)?.alternativa_d">
                            <div class="alternativa" *ngIf="$any(questao.data)?.alternativa_a">A) {{ $any(questao.data)?.alternativa_a }}</div>
                            <div class="alternativa" *ngIf="$any(questao.data)?.alternativa_b">B) {{ $any(questao.data)?.alternativa_b }}</div>
                            <div class="alternativa" *ngIf="$any(questao.data)?.alternativa_c">C) {{ $any(questao.data)?.alternativa_c }}</div>
                            <div class="alternativa" *ngIf="$any(questao.data)?.alternativa_d">D) {{ $any(questao.data)?.alternativa_d }}</div>
                            <div class="resposta-certa" *ngIf="$any(questao.data)?.resposta_correta">
                              Resposta: {{ $any(questao.data)?.resposta_correta?.toUpperCase() }}) {{ getAlternativaByLetra(questao, $any(questao.data)?.resposta_correta) }}
                            </div>
                          </div>
                        </ng-container>
                        <ng-container *ngIf="questao.tipo === 'correlacao'">
                          <div class="pergunta-correlacao" *ngIf="getColunaAFromRow(questao)?.length || getColunaBFromRow(questao)?.length">
                            <div class="correlacao-coluna">
                              <span class="correlacao-label">Coluna A:</span>
                              <div class="correlacao-item" *ngFor="let item of getColunaAFromRow(questao); let i = index">{{ i + 1 }}) {{ item }}</div>
                            </div>
                            <div class="correlacao-coluna">
                              <span class="correlacao-label">Coluna B:</span>
                              <div class="correlacao-item" *ngFor="let item of getColunaBFromRow(questao); let i = index">{{ getLetterForIndex(i) }}) {{ item }}</div>
                            </div>
                            <div class="correlacao-resposta" *ngIf="getCorrelacaoMappingsDisplay(questao)?.length">
                              <span class="correlacao-label">Resposta:</span>
                              <div class="correlacao-mapping-item" *ngFor="let m of getCorrelacaoMappingsDisplay(questao)">{{ m }}</div>
                            </div>
                          </div>
                        </ng-container>
                        <div class="pergunta-justificativa" *ngIf="questao.justificativa_resposta_certa">
                          Justificativa: {{ questao.justificativa_resposta_certa }}
                        </div>
                      </td>
                      <td>
                        <label class="toggle-label" *ngIf="isAdmin">
                          <input 
                            type="checkbox" 
                            [checked]="questao.caiu_em_prova"
                            (change)="onToggleCaiuEmProva(questao, $event.target.checked)"
                            [disabled]="togglingCaiuEmProva.has(questao.uniqueKey)"
                          />
                          <span>{{ togglingCaiuEmProva.has(questao.uniqueKey) ? 'Atualizando...' : questao.caiu_em_prova ? 'Sim' : 'Não' }}</span>
                        </label>
                        <span *ngIf="!isAdmin">{{ questao.caiu_em_prova ? 'Sim' : 'Não' }}</span>
                        <ng-container *ngIf="isAdmin && questao.caiu_em_prova">
                          <ng-container *ngIf="!isEditingAno(questao)">
                            <button class="btn btn-icon btn-ano" (click)="startEditingAno(questao)" [title]="'Editar ano' + (questao.ano_prova ? ' (' + questao.ano_prova + ')' : '')">
                              <img src="/assets/img/svg/calendar.svg" alt="Ano" class="btn-icon-img" />
                            </button>
                          </ng-container>
                          <div class="cell-edit-inline" *ngIf="isEditingAno(questao)">
                            <input 
                              type="number" 
                              [(ngModel)]="anoProvaInput" 
                              [name]="'ano-' + questao.id"
                              placeholder="Ex: 2024"
                              min="1900"
                              max="2100"
                              class="ano-input"
                            />
                            <button class="btn btn-small btn-save" (click)="saveAnoProva(questao)" [disabled]="togglingAnoProva.has(questao.uniqueKey)">
                              {{ togglingAnoProva.has(questao.uniqueKey) ? '...' : 'Salvar' }}
                            </button>
                            <button class="btn btn-small" (click)="cancelEditingAno()" [disabled]="togglingAnoProva.has(questao.uniqueKey)">
                              Cancelar
                            </button>
                          </div>
                        </ng-container>
                      </td>
                      <td>
                        <label class="toggle-label" *ngIf="isAdmin">
                          <input 
                            type="checkbox" 
                            [checked]="questao.caveira"
                            (change)="onToggleCaveira(questao, $event.target.checked)"
                            [disabled]="togglingCaveira.has(questao.uniqueKey)"
                          />
                          <span>{{ togglingCaveira.has(questao.uniqueKey) ? 'Atualizando...' : questao.caveira ? 'Sim' : 'Não' }}</span>
                        </label>
                        <span *ngIf="!isAdmin">{{ questao.caveira ? 'Sim' : 'Não' }}</span>
                      </td>
                      <td class="actions-cell">
                        <button class="btn btn-small" *ngIf="isAdmin" (click)="startEditingRow(questao)">
                          {{ isEditing(questao) ? 'Editando...' : 'Editar' }}
                        </button>
                      </td>
                    </tr>
                    <tr *ngIf="isEditing(questao)">
                      <td colspan="6">
                        <div class="edit-form">
                          <div class="edit-form-header">
                            <img src="/assets/img/svg/edit.svg" alt="Editar" class="edit-form-icon" />
                            <span>Editando questão #{{ questao.id }}</span>
                          </div>
                          <!-- Formulário específico para Múltipla Escolha -->
                          <div *ngIf="questao.tipo === 'multipla'">
                            <div class="form-grid form-grid-single">
                              <label>
                                Enunciado
                                <textarea 
                                  rows="3" 
                                  [(ngModel)]="editingFormData.pergunta" 
                                  name="pergunta-{{ questao.id }}"
                                ></textarea>
                              </label>
                              <label>
                                Páginas
                                <input 
                                  type="text" 
                                  [(ngModel)]="editingFormData.paginas" 
                                  name="paginas-{{ questao.id }}"
                                  placeholder="Ex: 45-50"
                                  maxlength="100"
                                />
                              </label>
                            </div>
                            <div class="form-grid multipla-grid">
                            <label>
                              Alternativa A
                              <textarea rows="2" [(ngModel)]="editingFormData.alternativa_a" name="mult-a-{{ questao.id }}"></textarea>
                            </label>
                            <label>
                              Alternativa B
                              <textarea rows="2" [(ngModel)]="editingFormData.alternativa_b" name="mult-b-{{ questao.id }}"></textarea>
                            </label>
                            <label>
                              Alternativa C
                              <textarea rows="2" [(ngModel)]="editingFormData.alternativa_c" name="mult-c-{{ questao.id }}"></textarea>
                            </label>
                            <label>
                              Alternativa D
                              <textarea rows="2" [(ngModel)]="editingFormData.alternativa_d" name="mult-d-{{ questao.id }}"></textarea>
                            </label>
                            <label>
                              Resposta Correta
                              <select [(ngModel)]="editingFormData.resposta_correta" name="resp-{{ questao.id }}">
                                <option value="a">A</option>
                                <option value="b">B</option>
                                <option value="c">C</option>
                                <option value="d">D</option>
                              </select>
                            </label>
                            </div>
                            <div class="form-grid">
                              <label>
                                Justificativa
                                <textarea 
                                  rows="3" 
                                  [(ngModel)]="editingFormData.justificativa_resposta_certa" 
                                  name="just-{{ questao.id }}"
                                ></textarea>
                              </label>
                            </div>
                          </div>

                          <!-- Formulário específico para V/F -->
                          <div *ngIf="questao.tipo === 'vf'" class="form-grid vf-grid">
                            <label>
                              Enunciado
                              <textarea 
                                rows="3" 
                                [(ngModel)]="editingFormData.pergunta" 
                                name="pergunta-{{ questao.id }}"
                              ></textarea>
                            </label>
                            <label>
                              Páginas
                              <input 
                                type="text" 
                                [(ngModel)]="editingFormData.paginas" 
                                name="paginas-vf-{{ questao.id }}"
                                placeholder="Ex: 45-50"
                                maxlength="100"
                              />
                            </label>
                            <label>
                              Afirmação Verdadeira
                              <textarea rows="2" [(ngModel)]="editingFormData.afirmacao_verdadeira" name="vf-v-{{ questao.id }}"></textarea>
                            </label>
                            <label>
                              Afirmação Falsa
                              <textarea rows="2" [(ngModel)]="editingFormData.afirmacao_falsa" name="vf-f-{{ questao.id }}"></textarea>
                            </label>
                            <label>
                              Justificativa
                              <textarea 
                                rows="3" 
                                [(ngModel)]="editingFormData.justificativa_resposta_certa" 
                                name="just-{{ questao.id }}"
                              ></textarea>
                            </label>
                          </div>

                          <!-- Formulário específico para Correlação -->
                          <div *ngIf="questao.tipo === 'correlacao'">
                            <div class="form-grid form-grid-single">
                              <label>
                                Enunciado
                                <textarea 
                                  rows="3" 
                                  [(ngModel)]="editingFormData.pergunta" 
                                  name="pergunta-{{ questao.id }}"
                                ></textarea>
                              </label>
                              <label>
                                Páginas
                                <input 
                                  type="text" 
                                  [(ngModel)]="editingFormData.paginas" 
                                  name="paginas-cor-{{ questao.id }}"
                                  placeholder="Ex: 45-50"
                                  maxlength="100"
                                />
                              </label>
                            </div>
                            <div class="form-grid form-grid-single">
                              <label>
                                Coluna A (uma linha por item - será numerada automaticamente: 1), 2), 3)...)
                                <textarea 
                                  rows="4" 
                                  [(ngModel)]="editingFormData.coluna_a_text" 
                                  (input)="onColunaAChange(questao.uniqueKey)"
                                  name="cor-a-{{ questao.id }}"
                                  placeholder="Item 1&#10;Item 2&#10;Item 3"
                                ></textarea>
                                <div class="coluna-preview" *ngIf="editingFormData.coluna_a_text">
                                  <strong>Preview:</strong>
                                  <div *ngFor="let item of getColunaAItemsForPreview(editingFormData.coluna_a_text); let i = index" class="preview-item">
                                    {{ i + 1 }}) {{ item }}
                                  </div>
                                </div>
                              </label>
                              <label>
                                Coluna B (uma linha por item - será letrada automaticamente: A), B), C)...)
                                <textarea 
                                  rows="4" 
                                  [(ngModel)]="editingFormData.coluna_b_text" 
                                  (input)="onColunaBChange(questao.uniqueKey)"
                                  name="cor-b-{{ questao.id }}"
                                  placeholder="Opção A&#10;Opção B&#10;Opção C"
                                ></textarea>
                                <div class="coluna-preview" *ngIf="editingFormData.coluna_b_text">
                                  <strong>Preview:</strong>
                                  <div *ngFor="let item of getColunaBItemsForPreview(editingFormData.coluna_b_text); let i = index" class="preview-item">
                                    {{ getLetterForIndex(i) }}) {{ item }}
                                  </div>
                                </div>
                              </label>
                            </div>
                            
                            <!-- Mapeamento de Resposta Correta -->
                            <div class="correlacao-mapping" *ngIf="editingFormData.correlacao_mappings && editingFormData.correlacao_mappings.length > 0">
                              <h4>Resposta Correta - Relacione cada item da Coluna A com um item da Coluna B:</h4>
                              <div class="mapping-list">
                                <div *ngFor="let mapping of editingFormData.correlacao_mappings; let i = index" class="mapping-item">
                                  <div class="mapping-label">
                                    <strong>{{ i + 1 }})</strong> {{ mapping.colunaA || '(vazio)' }}
                                  </div>
                                  <select 
                                    [(ngModel)]="mapping.respostaIndex"
                                    (ngModelChange)="updateCorrelacaoMapping(i, $event)"
                                    [name]="'mapping-' + questao.id + '-' + i"
                                    class="mapping-select"
                                  >
                                    <option [ngValue]="null">-- Não relacionar --</option>
                                    <option *ngFor="let itemB of getColunaBItems(); let j = index" [ngValue]="j">
                                      {{ getLetterForIndex(j) }}) {{ itemB }}
                                    </option>
                                  </select>
                                </div>
                              </div>
                            </div>
                            <div class="form-grid">
                              <label>
                                Justificativa
                                <textarea 
                                  rows="3" 
                                  [(ngModel)]="editingFormData.justificativa_resposta_certa" 
                                  name="just-{{ questao.id }}"
                                ></textarea>
                              </label>
                            </div>
                          </div>

                          <div *ngIf="editError" class="edit-error">
                            {{ editError }}
                          </div>

                          <div class="edit-actions">
                            <div class="edit-actions-left">
                              <button class="btn btn-small btn-save" (click)="saveEditingRow(questao)" [disabled]="isSavingEdit">
                                {{ isSavingEdit ? 'Salvando...' : 'Salvar' }}
                              </button>
                              <button class="btn btn-small" type="button" (click)="cancelEditing()" [disabled]="isSavingEdit">
                                Cancelar
                              </button>
                            </div>
                            <div class="edit-actions-right">
                              <button class="btn btn-small btn-delete" type="button" (click)="confirmDeleteQuestion(questao)" [disabled]="isSavingEdit">
                                Excluir
                              </button>
                            </div>
                          </div>
                        </div>
                      </td>
                    </tr>
                  </ng-container>
                </tbody>
              </table>
            </div>
          </div>

          <div *ngIf="tableData.length === 0" class="empty">
            Nenhuma questão de correlação encontrada para as bibliografias selecionadas.
          </div>
        </div>
      </mat-tab>

      <mat-tab>
        <ng-template mat-tab-label>
          Objetivas/Flashcards
          <span class="tab-count" *ngIf="allTableData.length > 0">
            ({{ getQuestoesCountByType('flashcard') }})
          </span>
        </ng-template>
        <div class="tab-content">
          <div *ngFor="let grupo of tableData" class="bibliografia-card">
            <div class="grupo-header">
              <div>
                <h2>{{ grupo.bibliografiaTitulo }}</h2>
                <p>{{ grupo.questoes.length }} {{ grupo.questoes.length === 1 ? 'flashcard' : 'flashcards' }}</p>
              </div>
            </div>

            <div class="tabela-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Pergunta / Resposta</th>
                    <th>
                      <div class="header-with-icon">
                        <img src="/assets/img/svg/star.svg" alt="Caiu em prova" class="header-icon star-icon" />
                        <span>Caiu em prova</span>
                      </div>
                    </th>
                    <th>
                      <div class="header-with-icon">
                        <img src="/assets/img/svg/danger.svg" alt="Caveira" class="header-icon danger-icon" />
                        <span>Caveira</span>
                      </div>
                    </th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody>
                  <ng-container *ngFor="let questao of grupo.questoes">
                    <tr [class.editing-row]="isEditing(questao)" [class.row-caiu-prova]="questao.caiu_em_prova && !questao.caveira" [class.row-caveira]="questao.caveira">
                      <td>#{{ questao.id }}</td>
                      <td>
                        <div class="pergunta-texto">{{ questao.pergunta }}</div>
                        <div class="pergunta-justificativa" *ngIf="$any(questao.data)?.resposta">
                          Resposta: {{ $any(questao.data)?.resposta }}
                        </div>
                      </td>
                      <td>
                        <label class="toggle-label" *ngIf="isAdmin">
                          <input
                            type="checkbox"
                            [checked]="questao.caiu_em_prova"
                            (change)="onToggleCaiuEmProva(questao, $event.target.checked)"
                            [disabled]="togglingCaiuEmProva.has(questao.uniqueKey)"
                          />
                          <span>{{ togglingCaiuEmProva.has(questao.uniqueKey) ? 'Atualizando...' : questao.caiu_em_prova ? 'Sim' : 'Não' }}</span>
                        </label>
                        <span *ngIf="!isAdmin">{{ questao.caiu_em_prova ? 'Sim' : 'Não' }}</span>
                        <ng-container *ngIf="isAdmin && questao.caiu_em_prova">
                          <ng-container *ngIf="!isEditingAno(questao)">
                            <button class="btn btn-icon btn-ano" (click)="startEditingAno(questao)" [title]="'Editar ano' + (questao.ano_prova ? ' (' + questao.ano_prova + ')' : '')">
                              <img src="/assets/img/svg/calendar.svg" alt="Ano" class="btn-icon-img" />
                            </button>
                          </ng-container>
                          <div class="cell-edit-inline" *ngIf="isEditingAno(questao)">
                            <input
                              type="number"
                              [(ngModel)]="anoProvaInput"
                              [name]="'ano-flash-' + questao.id"
                              placeholder="Ex: 2024"
                              min="1900"
                              max="2100"
                              class="ano-input"
                            />
                            <button class="btn btn-small btn-save" (click)="saveAnoProva(questao)" [disabled]="togglingAnoProva.has(questao.uniqueKey)">
                              {{ togglingAnoProva.has(questao.uniqueKey) ? '...' : 'Salvar' }}
                            </button>
                            <button class="btn btn-small" (click)="cancelEditingAno()" [disabled]="togglingAnoProva.has(questao.uniqueKey)">
                              Cancelar
                            </button>
                          </div>
                        </ng-container>
                      </td>
                      <td>
                        <label class="toggle-label" *ngIf="isAdmin">
                          <input
                            type="checkbox"
                            [checked]="questao.caveira"
                            (change)="onToggleCaveira(questao, $event.target.checked)"
                            [disabled]="togglingCaveira.has(questao.uniqueKey)"
                          />
                          <span>{{ togglingCaveira.has(questao.uniqueKey) ? 'Atualizando...' : questao.caveira ? 'Sim' : 'Não' }}</span>
                        </label>
                        <span *ngIf="!isAdmin">{{ questao.caveira ? 'Sim' : 'Não' }}</span>
                      </td>
                      <td class="actions-cell">
                        <button class="btn btn-small" *ngIf="isAdmin" (click)="startEditingRow(questao)">
                          {{ isEditing(questao) ? 'Editando...' : 'Editar' }}
                        </button>
                      </td>
                    </tr>
                    <tr *ngIf="isEditing(questao)">
                      <td colspan="5">
                        <div class="edit-form">
                          <div class="edit-form-header">
                            <img src="/assets/img/svg/edit.svg" alt="Editar" class="edit-form-icon" />
                            <span>Editando flashcard #{{ questao.id }}</span>
                          </div>

                          <div class="form-grid form-grid-single">
                            <label>
                              Pergunta
                              <textarea
                                rows="3"
                                [(ngModel)]="editingFormData.pergunta"
                                name="flash-pergunta-{{ questao.id }}"
                              ></textarea>
                            </label>
                            <label>
                              Resposta
                              <textarea
                                rows="4"
                                [(ngModel)]="editingFormData.resposta"
                                name="flash-resposta-{{ questao.id }}"
                              ></textarea>
                            </label>
                          </div>

                          <div *ngIf="editError" class="edit-error">
                            {{ editError }}
                          </div>

                          <div class="edit-actions">
                            <div class="edit-actions-left">
                              <button class="btn btn-small btn-save" (click)="saveEditingRow(questao)" [disabled]="isSavingEdit">
                                {{ isSavingEdit ? 'Salvando...' : 'Salvar' }}
                              </button>
                              <button class="btn btn-small" type="button" (click)="cancelEditing()" [disabled]="isSavingEdit">
                                Cancelar
                              </button>
                            </div>
                            <div class="edit-actions-right">
                              <button class="btn btn-small btn-delete" type="button" (click)="confirmDeleteQuestion(questao)" [disabled]="isSavingEdit">
                                Excluir
                              </button>
                            </div>
                          </div>
                        </div>
                      </td>
                    </tr>
                  </ng-container>
                </tbody>
              </table>
            </div>
          </div>

          <div *ngIf="tableData.length === 0" class="empty">
            Nenhum flashcard encontrado para as bibliografias selecionadas.
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>

  <!-- Janela de confirmação de exclusão -->
  <app-janela-generica
    titulo="Excluir questão"
    [mostrar]="mostrarJanelaExcluir"
    [botoes]="botoesJanelaExcluir"
    [isLoading]="isSavingEdit"
    [maxWidth]="'440px'"
    (fechar)="fecharJanelaExcluir()">
    <div class="confirm-excluir-content">
      <svg class="confirm-excluir-icon" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-label="Atenção">
        <defs>
          <linearGradient id="confirm-crisis-grad1" gradientUnits="userSpaceOnUse" x1="12.134" x2="42.027" y1="20.336" y2="41.389">
            <stop offset="0" stop-color="#fed200"/>
            <stop offset="1" stop-color="#f59815"/>
          </linearGradient>
          <linearGradient id="confirm-crisis-grad2" gradientUnits="userSpaceOnUse" x1="20.318" x2="27.55" y1="15.588" y2="26.115">
            <stop offset="0" stop-color="#3e4154"/>
            <stop offset="1" stop-color="#1b2129"/>
          </linearGradient>
          <linearGradient id="confirm-crisis-grad3" x1="21.779" x2="26.076" y1="32.279" y2="36.576" xlink:href="#confirm-crisis-grad2"/>
        </defs>
        <path d="m44.5 34.5-16.17-28a5 5 0 0 0 -8.66 0l-16.17 28a5 5 0 0 0 4.334 7.5h32.332a5 5 0 0 0 4.33-7.5z" fill="url(#confirm-crisis-grad1)"/>
        <path d="m24 30a2.1 2.1 0 0 0 2.1-1.9l1.18-11.8a3 3 0 0 0 -2.99-3.3h-.58a3 3 0 0 0 -2.985 3.3l1.18 11.8a2.1 2.1 0 0 0 2.095 1.9z" fill="url(#confirm-crisis-grad2)"/>
        <circle cx="24" cy="34.5" fill="url(#confirm-crisis-grad3)" r="3.5"/>
      </svg>
      <p class="confirm-excluir-mensagem">Tem certeza que deseja excluir esta questão? Esta decisão é irreversível.</p>
    </div>
  </app-janela-generica>
</div>
