<!-- Simulado de Perguntas - Layout com Tabs -->
<div class="simulado-container-simplified">
  
  <!-- Header com Estat√≠sticas -->
  <div class="header">
    <h2>üìù Perguntas</h2>
    <div class="stats" *ngIf="!isLoadingBibliografias">
      <span class="stat-item">
        <strong>{{ getStats().vf }}</strong> V/F
      </span>
      <span class="stat-item">
        <strong>{{ getStats().multipla }}</strong> M√∫ltipla
      </span>
      <span class="stat-item">
        <strong>{{ getStats().correlacao }}</strong> Correla√ß√£o
      </span>
      <span class="stat-item">
        <strong>{{ getStats().bibliografias }}</strong> {{ getStats().bibliografias === 1 ? 'bibliografia' : 'bibliografias' }}
      </span>
      <span class="stat-item">
        <strong>{{ getStats().assuntos }}</strong> {{ getStats().assuntos === 1 ? 'assunto' : 'assuntos' }}
      </span>
    </div>
  </div>
  
  <!-- Seletor de Bibliografia e Assunto - Sempre vis√≠vel -->
  <div class="filters-section" *ngIf="!isLoadingBibliografias">
    <div class="filter-row">
      <div class="filter-group">
        <label for="bibliografia-select">üìñ Bibliografia:</label>
        <select 
          id="bibliografia-select"
          class="filter-select"
          [(ngModel)]="selectedBibliografiaId"
          (change)="onBibliografiaChange()"
          [disabled]="isLoadingBibliografias"
        >
          <option [ngValue]="null">Todas as Bibliografias</option>
          <option 
            *ngFor="let bibliografia of bibliografiasComEstatisticas" 
            [ngValue]="bibliografia.id"
          >
            {{ getBibliografiaOptionText(bibliografia) }}
          </option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="assunto-select">üè∑Ô∏è Assunto:</label>
        <select 
          id="assunto-select"
          class="filter-select"
          [(ngModel)]="selectedAssunto"
          (change)="onAssuntoChange()"
          [disabled]="isLoadingBibliografias || assuntosDisponiveis.length === 0"
        >
          <option value="">Todos os Assuntos</option>
          <option 
            *ngFor="let assunto of assuntosDisponiveis" 
            [value]="assunto.nome"
          >
            {{ assunto.nome }} ({{ assunto.quantidade }}) - [{{ assunto.bibliografiaTitulo }}]
          </option>
        </select>
      </div>
    </div>

    <!-- A√ß√µes -->
    <div class="actions-row">
      <button 
        *ngIf="bibliografiaPath"
        class="btn btn-back"
        (click)="goToBibliografia()">
        <span class="back-arrow"></span>
        Voltar √† Bibliografia
      </button>
    </div>
  </div>
  
  <div *ngIf="isLoadingBibliografias" class="loading-text" style="text-align: center; padding: 1rem; color: #6b7280; font-style: italic;">
    Carregando bibliografias...
  </div>
  
  <!-- Sistema de Tabs -->
  <div class="tabs-container">
    <div class="tabs-header">
      <button 
        class="tab-button"
        [class.active]="activeTab === 'completo'"
        (click)="setActiveTab('completo')"
      >
        üìù Simulado (10VF, 6M, 4C)
      </button>
      <button 
        class="tab-button"
        [class.active]="activeTab === 'vf'"
        (click)="setActiveTab('vf')"
      >
        ‚úÖ Simulado Verdadeiro/Falso (20VF)
      </button>
      <button 
        class="tab-button"
        [class.active]="activeTab === 'multipla'"
        (click)="setActiveTab('multipla')"
      >
        üîò Simulado M√∫ltipla Escolha (10M)
      </button>
      <button 
        class="tab-button"
        [class.active]="activeTab === 'correlacao'"
        (click)="setActiveTab('correlacao')"
      >
        üîó Simulado Correla√ß√£o (5C)
      </button>
    </div>

    <!-- Conte√∫do do Tab -->
    <div class="tabs-content">
      <!-- Loading das Quest√µes -->
      <app-loading-spinner *ngIf="isLoadingQuestions" message="Carregando prova..."></app-loading-spinner>

      <!-- Prova Carregada -->
      <div *ngIf="questionsLoaded && !isLoadingQuestions" class="prova-loaded">
    
    <!-- Header da Prova -->
    <div class="prova-header">
      <div class="prova-info">
        <h2>üìù Quest√µes</h2>
        <div class="prova-stats">
          <span class="stat">Respondidas: {{ getTotalAnsweredQuestions() }}/{{ simuladoQuestions.length }}</span>
          <span class="stat">Acertos: {{ getTotalCorrectAnswers() }}</span>
          <span class="stat" [class.good-score]="getScorePercentage() >= 70">
            Performance: {{ getScorePercentage().toFixed(1) }}%
          </span>
        </div>
      </div>
      
      <div class="prova-actions">
        <button 
          class="btn btn-revisar"
          *ngIf="isAdmin"
          (click)="openRevisarQuestoes()"
          aria-label="Revisar Quest√µes"
        >
          Revisar Quest√µes
        </button>
        <button 
          class="btn btn-pdf"
          (click)="downloadAsPDF()"
          [disabled]="simuladoQuestions.length === 0 || isGeneratingPDF"
          [attr.aria-label]="isGeneratingPDF ? 'Gerando PDF' : 'Salvar PDF'"
        >
          {{ isGeneratingPDF ? 'Gerando PDF...' : 'Salvar PDF' }}
        </button>
        <button 
          class="btn btn-nova gerar-nova-prova-btn"
          (click)="gerarNovaProva()"
          [disabled]="isLoadingQuestions"
          aria-label="Gerar Nova Prova"
        >
          Gerar Nova Prova
        </button>
      </div>
    </div>

    <!-- Lista de Quest√µes -->
    <div class="questoes-list">
      <div 
        *ngFor="let question of simuladoQuestions; let i = index" 
        class="questao-item"
        [class.answered]="question.uniqueKey && isQuestionAnswered(question.uniqueKey)"
        [class.correct]="question.uniqueKey && getQuestionAnswerStatus(question.uniqueKey) === 'correct'"
        [class.incorrect]="question.uniqueKey && getQuestionAnswerStatus(question.uniqueKey) === 'incorrect'"
      >
        
        <!-- Cabe√ßalho da Quest√£o -->
        <div class="questao-header">
          <div class="questao-header-content">
            <span class="questao-titulo">
              <img 
                *ngIf="getCaiuEmProvaStatus(question)"
                src="/assets/img/svg/danger.svg" 
                alt="Caiu em prova"
                class="danger-icon"
              />
              Quest√£o {{ i + 1 }}
              <span class="tipo-badge" [class]="'tipo-' + question.tipo">
                {{ question.tipo === 'vf' ? 'V/F' : 
                   question.tipo === 'multipla' ? 'M√∫ltipla' : 'Correla√ß√£o' }}
              </span>
            </span>
            
            <span class="separator" *ngIf="question.bibliografia_titulo || question.paginas || question.assunto">|</span>
            
            <span *ngIf="question.bibliografia_titulo" class="bibliografia">
              üìö {{ question.bibliografia_titulo }}
            </span>
            
            <span class="separator" *ngIf="question.paginas || question.assunto">|</span>
            
            <span *ngIf="question.paginas" class="paginas">
              üìÑ {{ question.paginas }}
            </span>
            
            <span class="separator" *ngIf="question.assunto">|</span>
            
            <span *ngIf="question.assunto_titulo" class="assunto">
              üè∑Ô∏è {{ question.assunto_titulo }}
            </span>
          </div>

          <div class="questao-tools">
            <!-- Status da Resposta -->
            <div class="answer-status">
              <div *ngIf="question.uniqueKey && getQuestionAnswerStatus(question.uniqueKey) === 'correct'" class="status-badge correct">
                ‚úÖ Correta
              </div>
              <div *ngIf="question.uniqueKey && getQuestionAnswerStatus(question.uniqueKey) === 'incorrect'" class="status-badge incorrect">
                ‚ùå Incorreta
              </div>
            </div>
            <div class="tools-actions">
              <button
                class="btn btn-highlight"
                *ngIf="isAdmin || canViewMarkdown(question)"
                (click)="openMarkdownViewer(question)"
              >
                Texto de apoio
              </button>
              <button 
                class="btn btn-omit"
                (click)="omitirQuestao(question)"
                [disabled]="isOmitindoQuestao(question)"
              >
                {{ isOmitindoQuestao(question) ? 'Omitindo...' : 'Omitir' }}
              </button>
              <button
                class="btn btn-edit"
                *ngIf="isAdmin"
                (click)="startEditingQuestion(question)"
              >
                {{ editingQuestionKey === question.uniqueKey ? 'Editando...' : 'Editar' }}
              </button>
            </div>
          </div>
        </div>

        <div class="caiu-prova-toggle" *ngIf="isAdmin">
          <label>
            <input 
              type="checkbox" 
              [checked]="getCaiuEmProvaStatus(question)" 
              (change)="onToggleCaiuEmProva(question, $event.target.checked)"
              [disabled]="isTogglingCaiuEmProva(question)"
            />
            Caiu em prova
          </label>
          <span class="toggle-status" *ngIf="isTogglingCaiuEmProva(question)">Atualizando...</span>
        </div>

        <!-- Conte√∫do da Quest√£o -->
        <div class="questao-content">

          <!-- Pergunta Verdadeiro/Falso - Componente Espec√≠fico -->
          <app-pergunta-v-f
            *ngIf="question.tipo === 'vf'"
            [questionId]="question.id"
            [questionData]="getVFData(question)"
            [isAnswered]="questionResults[question.uniqueKey!]?.answered || false"
            [isCorrect]="questionResults[question.uniqueKey!]?.isCorrect || false"
            (answerSubmitted)="onAnswerSubmitted($event)"
          ></app-pergunta-v-f>

          <!-- Pergunta M√∫ltipla Escolha - Componente Espec√≠fico -->
          <app-pergunta-multipla
            *ngIf="question.tipo === 'multipla'"
            [questionId]="question.id"
            [questionData]="getMultiplaData(question)"
            [isAnswered]="questionResults[question.uniqueKey!]?.answered || false"
            [isCorrect]="questionResults[question.uniqueKey!]?.isCorrect || false"
            (answerSubmitted)="onAnswerSubmitted($event)"
          ></app-pergunta-multipla>

          <!-- Pergunta de Correla√ß√£o - Componente Espec√≠fico -->
          <app-pergunta-correlacao
            *ngIf="question.tipo === 'correlacao'"
            [questionId]="question.id"
            [questionData]="getCorrelacaoData(question)"
            [isAnswered]="questionResults[question.uniqueKey!]?.answered || false"
            [isCorrect]="questionResults[question.uniqueKey!]?.isCorrect || false"
            (answerSubmitted)="onAnswerSubmitted($event)"
          ></app-pergunta-correlacao>

        </div>

        <div 
          class="question-edit-form" 
          *ngIf="isAdmin && editingQuestionKey === question.uniqueKey && editingFormData"
        >
          <h4>Edi√ß√£o da Quest√£o</h4>

          <div class="form-grid">
            <label *ngIf="question.tipo !== 'vf'">
              Enunciado
              <textarea 
                rows="3" 
                [(ngModel)]="editingFormData.pergunta" 
                [name]="'pergunta-' + question.uniqueKey"
              ></textarea>
            </label>
            <label>
              P√°ginas
              <input 
                type="text" 
                [(ngModel)]="editingFormData.paginas"
                [name]="'paginas-' + question.uniqueKey"
              />
            </label>
            <label>
              Justificativa
              <textarea 
                rows="3" 
                [(ngModel)]="editingFormData.justificativa_resposta_certa" 
                [name]="'justificativa-' + question.uniqueKey"
              ></textarea>
            </label>
          </div>

          <div *ngIf="question.tipo === 'multipla'" class="form-grid multipla-grid">
            <label>
              Alternativa A
              <textarea rows="2" [(ngModel)]="editingFormData.alternativa_a" [name]="'a-' + question.uniqueKey"></textarea>
            </label>
            <label>
              Alternativa B
              <textarea rows="2" [(ngModel)]="editingFormData.alternativa_b" [name]="'b-' + question.uniqueKey"></textarea>
            </label>
            <label>
              Alternativa C
              <textarea rows="2" [(ngModel)]="editingFormData.alternativa_c" [name]="'c-' + question.uniqueKey"></textarea>
            </label>
            <label>
              Alternativa D
              <textarea rows="2" [(ngModel)]="editingFormData.alternativa_d" [name]="'d-' + question.uniqueKey"></textarea>
            </label>
            <label>
              Resposta Correta
              <select [(ngModel)]="editingFormData.resposta_correta" [name]="'resposta-' + question.uniqueKey">
                <option value="a">Alternativa A</option>
                <option value="b">Alternativa B</option>
                <option value="c">Alternativa C</option>
                <option value="d">Alternativa D</option>
              </select>
            </label>
          </div>

          <div *ngIf="question.tipo === 'vf'" class="form-grid">
            <label>
              Pergunta
              <textarea rows="3" [(ngModel)]="editingFormData.pergunta" [name]="'vf-pergunta-' + question.uniqueKey"></textarea>
            </label>
            <label>
              Afirma√ß√£o Verdadeira
              <textarea rows="3" [(ngModel)]="editingFormData.afirmacao_verdadeira" [name]="'vf-verdadeira-' + question.uniqueKey"></textarea>
            </label>
            <label>
              Afirma√ß√£o Falsa
              <textarea rows="3" [(ngModel)]="editingFormData.afirmacao_falsa" [name]="'vf-falsa-' + question.uniqueKey"></textarea>
            </label>
          </div>

          <div *ngIf="question.tipo === 'correlacao'" class="form-grid">
            <label>
              Coluna A (uma entrada por linha)
              <textarea rows="4" [(ngModel)]="editingFormData.coluna_a_text" [name]="'colA-' + question.uniqueKey"></textarea>
            </label>
            <label>
              Coluna B (uma entrada por linha)
              <textarea rows="4" [(ngModel)]="editingFormData.coluna_b_text" [name]="'colB-' + question.uniqueKey"></textarea>
            </label>
            <label>
              Resposta Correta (JSON)
              <textarea rows="4" [(ngModel)]="editingFormData.resposta_correta_text" [name]="'resp-' + question.uniqueKey"></textarea>
            </label>
          </div>

          <div *ngIf="editError" class="edit-error">
            {{ editError }}
          </div>

          <div class="edit-actions">
            <button 
              class="btn btn-primary" 
              (click)="saveQuestionEdits()" 
              [disabled]="isSavingEdit"
            >
              {{ isSavingEdit ? 'Salvando...' : 'Salvar altera√ß√µes' }}
            </button>
            <button 
              type="button"
              class="btn btn-secondary" 
              (click)="cancelEditingQuestion()"
              [disabled]="isSavingEdit"
            >
              Cancelar
            </button>
          </div>
        </div>
      </div>

      <!-- Mensagem se n√£o h√° quest√µes ou quest√µes insuficientes -->
      <div *ngIf="!questionsLoaded && !isLoadingQuestions" class="no-questions">
        <h3 *ngIf="!insufficientQuestionsMessage">ü§î Nenhuma prova carregada</h3>
        <h3 *ngIf="insufficientQuestionsMessage">‚ö†Ô∏è N√£o foi poss√≠vel gerar a prova</h3>
        
        <div *ngIf="insufficientQuestionsMessage" class="insufficient-message">
          <p>{{ insufficientQuestionsMessage }}</p>
        </div>
        
        <p *ngIf="!insufficientQuestionsMessage">Configure as bibliografias e gere uma nova prova.</p>
        
        <button class="btn btn-primary" (click)="gerarNovaProva()">
          üöÄ Gerar Prova
        </button>
      </div>

      <!-- Bot√£o Gerar Nova Prova ao final (vis√≠vel apenas em smartphones) -->
      <div *ngIf="simuladoQuestions.length > 0" class="gerar-nova-prova-mobile">
        <button 
          class="btn btn-nova gerar-nova-prova-btn"
          (click)="gerarNovaProva()"
          [disabled]="isLoadingQuestions"
          aria-label="Gerar Nova Prova"
        >
          Gerar Nova Prova
        </button>
      </div>
    </div>

  <!-- Painel com quest√µes omitidas -->
  <div class="questoes-omitidas-panel">
    <div class="panel-header">
      <div>
        <h3>Quest√µes omitidas</h3>
        <p>Exclua temporariamente quest√µes repetidas e reative quando quiser.</p>
      </div>
      <span class="badge" *ngIf="!isLoadingQuestoesOmitidas">{{ questoesOmitidas.length }}</span>
    </div>

    <div *ngIf="isLoadingQuestoesOmitidas" class="omitidas-loading">
      Carregando quest√µes omitidas...
    </div>

    <div *ngIf="!isLoadingQuestoesOmitidas" class="omitidas-actions">
      <p class="omitidas-summary" *ngIf="questoesOmitidas.length === 0">
        Nenhuma quest√£o omitida no momento.
      </p>
      <p class="omitidas-summary" *ngIf="questoesOmitidas.length > 0">
        Voc√™ possui {{ questoesOmitidas.length }} {{ questoesOmitidas.length === 1 ? 'quest√£o omitida' : 'quest√µes omitidas' }}.
      </p>
      <button class="btn btn-tertiary" (click)="openQuestoesOmitidasWindow()" [disabled]="isLoadingQuestoesOmitidas">
        Gerenciar em nova janela
      </button>
    </div>
  </div>    
  </div>

</div>
