upstream backend_upstream {
    zone backend_upstream 64k;
    server cemos2028_backend:8000 resolve max_fails=3 fail_timeout=30s;
}

upstream dash_upstream {
    zone dash_upstream 64k;
    server cemos2028_dash:8050 resolve max_fails=3 fail_timeout=30s;
}

resolver 127.0.0.11 ipv6=off valid=30s;

# ðŸ”¹ HTTP server - para desenvolvimento local
server {
    listen 80;
    listen 8088;
    server_name localhost 127.0.0.1;

    # FRONTEND Angular - CEMOS2028
    location / {
        root /usr/share/nginx/cemos2028;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # Em desenvolvimento, a tela de login deve abrir no Angular dev server.
    location = /login {
        return 302 http://localhost:4200/login;
    }

    location = /login/ {
        return 302 http://localhost:4200/login;
    }

    # BACKEND Django API
    location /api/ {
        proxy_pass http://backend_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Headers para desenvolvimento
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
    }

    # BACKEND Django Auth pages (server-side templates)
    location ~ ^/(logout|register|password-change|password-reset|reset)/ {
        proxy_pass http://backend_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /auth/login/ {
        proxy_pass http://backend_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # DASH (Plotly) via rota /dash/
    location /dash/ {
        rewrite ^/dash/(.*)$ /$1 break;
        proxy_pass http://dash_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ADMIN
    location /admin {
        proxy_pass http://backend_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # DJANGO STATIC FILES
    location /static/ {
        alias /static/;
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
    }

    # MEDIA / DOCUMENTS
    location /arquivos/ {
        alias /var/www/arquivos/;
        autoindex off;
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Access-Control-Allow-Origin *;
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }

    # Gzip habilitado para desenvolvimento tambÃ©m
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml image/svg+xml;
    gzip_min_length 256;
}